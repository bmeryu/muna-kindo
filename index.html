<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rutinas Mágicas</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Fredoka', sans-serif;
            background: #fdf5e6; /* Fondo color crema */
            transition: background-color 0.3s ease;
        }
        body.night-mode {
            background-color: #2c3e50; /* Azul oscuro */
            color: #ecf0f1;
        }
        .text-clay {
            color: #d2b48c; /* Tonos arcilla */
        }
        .confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #f7a5a8;
            opacity: 0;
            animation: confetti-fall 3s ease-in-out forwards;
        }
        @keyframes confetti-fall {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
        .checkbox-magic {
            transition: all 0.2s ease-in-out;
        }
        .checkbox-magic:checked + .task-label {
            text-decoration: line-through;
            color: #888;
        }
        .progress-bar {
            background-color: #f2f2f2;
            border-radius: 9999px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            transition: width 0.5s ease-in-out;
            background-color: #4CAF50; /* Verde */
            background-image: linear-gradient(to right, #6ab187, #4CAF50);
        }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variables globales
        let db;
        let auth;
        let userId;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        let appState = {
            childName: "Pequeño Héroe",
            avatar: "🐸",
            theme: "jungle",
            tasks: {
                Lunes: { AM: [], PM: [], Noche: [] },
                Martes: { AM: [], PM: [], Noche: [] },
                Miércoles: { AM: [], PM: [], Noche: [] },
                Jueves: { AM: [], PM: [], Noche: [] },
                Viernes: { AM: [], PM: [], Noche: [] },
                Sábado: { AM: [], PM: [], Noche: [] },
                Domingo: { AM: [], PM: [], Noche: [] }
            },
            rewards: []
        };
        
        // Elementos del DOM
        const appContainer = document.getElementById('app-container');
        const homeView = document.getElementById('home-view');
        const tasksContainer = document.getElementById('tasks-container');
        const rewardsContainer = document.getElementById('rewards-container');
        const settingsContainer = document.getElementById('settings-container');
        const confettiContainer = document.getElementById('confetti-container');
        const progressBar = document.getElementById('progress-bar');
        const progressBarFill = document.getElementById('progress-bar-fill');
        const addChildForm = document.getElementById('add-child-form');
        const childNameInput = document.getElementById('child-name-input');
        const childAvatarSelect = document.getElementById('child-avatar-select');
        const saveSettingsBtn = document.getElementById('save-settings-btn');
        const addTaskForm = document.getElementById('add-task-form');
        const addTaskInput = document.getElementById('add-task-input');
        const addTaskBtn = document.getElementById('add-task-btn');
        const activeDayEl = document.getElementById('active-day');
        const activeTimeEl = document.getElementById('active-time');
        const currentUserIdDisplay = document.getElementById('current-user-id');
        const welcomeMessage = document.getElementById('welcome-message');

        let activeDay = "Lunes";
        let activeTime = "AM";
        const days = ["Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado", "Domingo"];
        const times = ["AM", "PM", "Noche"];
        const predefinedTasks = [
            "Lavarse los dientes",
            "Hacer la cama",
            "Ponerse el pijama",
            "Ordenar los juguetes",
            "Comer vegetales",
            "Leer un cuento"
        ];
        const avatars = ["🐸", "🐰", "🐻", "🦖", "🦄", "🐼"];

        // Inicialización de Firebase
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    currentUserIdDisplay.textContent = `ID de sesión: ${userId}`;
                    
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'rutinas_magicas');
                    
                    onSnapshot(docRef, (docSnap) => {
                        if (docSnap.exists() && docSnap.data().data) {
                            appState = JSON.parse(docSnap.data().data);
                            renderUI();
                        } else {
                            // Cargar tareas predefinidas si no hay datos
                            days.forEach(day => {
                                appState.tasks[day].AM = predefinedTasks.slice(0, 2).map(text => ({ text, completed: false }));
                                appState.tasks[day].PM = predefinedTasks.slice(2, 4).map(text => ({ text, completed: false }));
                                appState.tasks[day].Noche = predefinedTasks.slice(4, 6).map(text => ({ text, completed: false }));
                            });
                            saveData();
                            renderUI();
                        }
                    }, (error) => {
                        console.error("Error al escuchar los cambios:", error);
                        // En caso de error, inicializar con datos locales
                        renderUI();
                    });

                } else {
                    await signInAnonymously(auth);
                }
            });
        } catch (error) {
            console.error("Error al inicializar Firebase:", error);
            // Fallback en caso de que Firebase falle
            renderUI();
        }
        
        // --- Funciones de Lógica de la Aplicación ---
        function saveData() {
            if (db && userId) {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'rutinas_magicas');
                setDoc(docRef, { data: JSON.stringify(appState) })
                    .catch(error => console.error("Error al guardar datos:", error));
            }
        }
        
        function renderUI() {
            renderHeader();
            renderTasks();
            renderRewards();
            updateProgressBar();
            renderDaySelectors();
            renderTimeSelectors();
        }

        function renderHeader() {
            welcomeMessage.textContent = `¡Hola, ${appState.childName}!`;
        }

        function renderDaySelectors() {
            const daySelectors = document.getElementById('day-selectors');
            daySelectors.innerHTML = '';
            days.forEach(day => {
                const button = document.createElement('button');
                button.textContent = day;
                button.classList.add('px-3', 'py-1', 'rounded-full', 'font-bold', 'transition-all', 'duration-300', 'text-sm');
                if (day === activeDay) {
                    button.classList.add('bg-orange-400', 'text-white', 'shadow-md');
                } else {
                    button.classList.add('bg-white', 'text-gray-600', 'shadow-sm', 'hover:bg-orange-200');
                }
                button.onclick = () => {
                    activeDay = day;
                    renderUI();
                };
                daySelectors.appendChild(button);
            });
            activeDayEl.textContent = activeDay;
        }

        function renderTimeSelectors() {
            const timeSelectors = document.getElementById('time-selectors');
            timeSelectors.innerHTML = '';
            times.forEach(time => {
                const button = document.createElement('button');
                button.textContent = time;
                button.classList.add('px-3', 'py-1', 'rounded-full', 'font-bold', 'transition-all', 'duration-300', 'text-sm');
                if (time === activeTime) {
                    button.classList.add('bg-pink-400', 'text-white', 'shadow-md');
                } else {
                    button.classList.add('bg-white', 'text-gray-600', 'shadow-sm', 'hover:bg-pink-200');
                }
                button.onclick = () => {
                    activeTime = time;
                    renderUI();
                };
                timeSelectors.appendChild(button);
            });
            activeTimeEl.textContent = activeTime;
        }
        
        function renderTasks() {
            tasksContainer.innerHTML = '';
            const tasks = appState.tasks[activeDay][activeTime];
            if (!tasks || tasks.length === 0) {
                tasksContainer.innerHTML = '<p class="text-gray-500 italic text-center">¡No hay tareas para esta franja horaria!</p>';
                return;
            }

            tasks.forEach((task, index) => {
                const taskEl = document.createElement('div');
                taskEl.classList.add('bg-white', 'p-4', 'rounded-xl', 'shadow-md', 'flex', 'items-center', 'space-x-4', 'mb-3', 'cursor-pointer', 'transform', 'transition-all', 'duration-200', 'hover:scale-105');
                
                // Checkbox grande y colorido
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = task.completed;
                checkbox.classList.add('w-8', 'h-8', 'rounded-full', 'appearance-none', 'border-4', 'border-pink-300', 'bg-white', 'checked:bg-pink-400', 'checked:border-pink-500', 'checkbox-magic');
                checkbox.onclick = (e) => handleTaskCompletion(index, e.target.checked);

                const label = document.createElement('label');
                label.classList.add('flex-1', 'text-lg', 'task-label', 'font-semibold', 'text-gray-700', 'flex', 'items-center', 'gap-2');
                
                // Iconos
                let icon = '';
                if (task.text.toLowerCase().includes('dientes')) icon = '🦷';
                else if (task.text.toLowerCase().includes('cama')) icon = '🛏️';
                else if (task.text.toLowerCase().includes('juguetes')) icon = '🧸';
                else if (task.text.toLowerCase().includes('pijama')) icon = '👕';
                else if (task.text.toLowerCase().includes('cuento')) icon = '📖';
                else if (task.text.toLowerCase().includes('comer')) icon = '🍎';
                else icon = '✔️';

                label.innerHTML = `<span class="text-2xl">${icon}</span> <span>${task.text}</span>`;
                
                taskEl.appendChild(checkbox);
                taskEl.appendChild(label);
                
                // Botón de eliminar (visible para cuidadores)
                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = '🗑️';
                deleteBtn.classList.add('text-2xl', 'p-2', 'rounded-full', 'hover:bg-gray-200', 'hidden', 'caregiver-tool');
                deleteBtn.onclick = () => deleteTask(index);
                taskEl.appendChild(deleteBtn);

                tasksContainer.appendChild(taskEl);
            });
        }

        function renderRewards() {
            rewardsContainer.innerHTML = '';
            if (appState.rewards.length === 0) {
                rewardsContainer.innerHTML = '<p class="text-gray-500 italic text-center p-4">¡Aún no has ganado recompensas!</p>';
                return;
            }
            appState.rewards.forEach(reward => {
                const rewardEl = document.createElement('div');
                rewardEl.classList.add('bg-white', 'p-2', 'rounded-lg', 'text-center', 'shadow-md');
                rewardEl.innerHTML = `<span class="text-4xl">${reward.sticker}</span><p class="text-sm font-semibold text-gray-700 mt-1">${reward.text}</p>`;
                rewardsContainer.appendChild(rewardEl);
            });
        }

        function updateProgressBar() {
            const allTasksToday = appState.tasks[activeDay].AM.concat(appState.tasks[activeDay].PM, appState.tasks[activeDay].Noche);
            const completedTasks = allTasksToday.filter(task => task.completed).length;
            const totalTasks = allTasksToday.length;
            const progress = totalTasks > 0 ? (completedTasks / totalTasks) * 100 : 0;
            progressBarFill.style.width = `${progress}%`;

            if (progress === 100 && totalTasks > 0) {
                setTimeout(() => {
                    createConfetti();
                    // Simulamos que el niño recibe una recompensa por completar el día
                    const newReward = { text: "¡Día completado!", sticker: "🌟" };
                    appState.rewards.push(newReward);
                    saveData();
                    renderRewards();
                }, 500);
            }
        }

        function handleTaskCompletion(index, isCompleted) {
            appState.tasks[activeDay][activeTime][index].completed = isCompleted;
            
            if (isCompleted) {
                createConfetti();
            } else {
                // Si desmarca, también borramos la animación de confeti
            }
            saveData();
            updateProgressBar();
        }

        function addTask(text) {
            if (text.trim() === "") return;
            const newTask = { text: text, completed: false };
            appState.tasks[activeDay][activeTime].push(newTask);
            saveData();
            renderTasks();
            addTaskInput.value = "";
        }

        function deleteTask(index) {
            appState.tasks[activeDay][activeTime].splice(index, 1);
            saveData();
            renderTasks();
            updateProgressBar();
        }

        function createConfetti() {
            const colors = ['#f7a5a8', '#fecaca', '#fcd34d', '#bae6fd', '#c084fc'];
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.classList.add('confetti');
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.animationDelay = Math.random() * 2 + 's';
                confettiContainer.appendChild(confetti);
            }
            setTimeout(() => {
                confettiContainer.innerHTML = '';
            }, 3000);
        }

        // --- Event Listeners y Funciones del Panel de Control ---
        function showView(viewId) {
            const views = [homeView, rewardsContainer, settingsContainer];
            views.forEach(view => view.classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
        }

        document.getElementById('nav-home').onclick = () => showView('home-view');
        document.getElementById('nav-rewards').onclick = () => showView('rewards-view');
        document.getElementById('nav-settings').onclick = () => showView('settings-view');
        
        // Evento para guardar la configuración del niño
        saveSettingsBtn.onclick = () => {
            const newName = childNameInput.value.trim();
            const newAvatar = childAvatarSelect.value;
            if (newName) {
                appState.childName = newName;
                appState.avatar = newAvatar;
                saveData();
                renderUI();
                showView('home-view');
            }
        };

        // Evento para agregar una nueva tarea
        addTaskBtn.onclick = (e) => {
            e.preventDefault();
            addTask(addTaskInput.value);
        };

        // Evento para alternar modo noche
        document.getElementById('night-mode-toggle').onclick = () => {
            document.body.classList.toggle('night-mode');
        };

        // Evento para el botón de impresión
        document.getElementById('print-btn').onclick = () => {
            const printContent = document.getElementById('printable-content').cloneNode(true);
            const originalBody = document.body.innerHTML;
            document.body.innerHTML = '';
            document.body.appendChild(printContent);
            window.print();
            document.body.innerHTML = originalBody;
            location.reload(); // Recargar para restaurar la página
        };

        // Evento para el botón de narración (simulado)
        document.getElementById('narrate-btn').onclick = () => {
            const tasksText = appState.tasks[activeDay][activeTime].map(t => t.text).join('. ');
            console.log(`Simulando narración de las tareas: ${tasksText}`);
            const messageBox = document.createElement('div');
            messageBox.innerHTML = `
                <div class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
                    <div class="bg-white p-6 rounded-xl shadow-lg max-w-sm mx-auto text-center">
                        <p class="text-xl font-bold mb-4">¡Reproduciendo audio!</p>
                        <p class="text-gray-600">Simulando la narración de las tareas.</p>
                        <button onclick="this.closest('.fixed').remove()" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded-full">Cerrar</button>
                    </div>
                </div>
            `;
            document.body.appendChild(messageBox);
        };
        
        // Función para cambiar la visibilidad de las herramientas de cuidador
        document.getElementById('toggle-caregiver-tools').onclick = () => {
            document.querySelectorAll('.caregiver-tool').forEach(el => el.classList.toggle('hidden'));
        };

        // Rellenar las opciones de avatares
        avatars.forEach(avatar => {
            const option = document.createElement('option');
            option.value = avatar;
            option.textContent = avatar;
            childAvatarSelect.appendChild(option);
        });
        
        // Inicializar la vista
        window.onload = () => {
             showView('home-view');
        };
        
        // Asegúrate de que los IDs existan
        window.addEventListener('load', () => {
            if (document.getElementById('app-container')) {
                renderUI();
            }
        });

    </script>
</head>
<body class="p-4 sm:p-8">
    <div id="app-container" class="max-w-xl mx-auto bg-white rounded-3xl shadow-2xl overflow-hidden border-4 border-gray-100 p-6">
        
        <!-- Header del Sitio -->
        <header class="text-center mb-6">
            <h1 id="welcome-message" class="text-4xl font-bold text-pink-600">¡Hola, Pequeño Héroe!</h1>
            <p class="text-gray-500 font-medium">¡Vamos a conquistar el día!</p>
        </header>

        <!-- Navegación Principal -->
        <nav class="flex justify-around bg-gray-100 rounded-full p-2 mb-6 shadow-inner">
            <button id="nav-home" class="px-6 py-3 rounded-full font-bold text-gray-700 hover:bg-white transition-colors duration-300">Mis Tareas</button>
            <button id="nav-rewards" class="px-6 py-3 rounded-full font-bold text-gray-700 hover:bg-white transition-colors duration-300">Recompensas</button>
            <button id="nav-settings" class="px-6 py-3 rounded-full font-bold text-gray-700 hover:bg-white transition-colors duration-300">Configuración</button>
        </nav>
        
        <!-- Vista de Tareas (Principal) -->
        <div id="home-view" class="hidden">
            
            <!-- Selector de Día y Franja Horaria -->
            <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                <div id="day-selectors" class="flex flex-wrap gap-2 justify-center"></div>
                <div id="time-selectors" class="flex flex-wrap gap-2 justify-center"></div>
            </div>

            <div class="text-center font-bold text-xl text-gray-600 mb-4">
                <span id="active-day" class="text-orange-600"></span>, <span id="active-time" class="text-pink-600"></span>
            </div>
            
            <div id="printable-content">
                <div id="tasks-container">
                    <!-- Las tareas se renderizarán aquí -->
                </div>
            </div>

            <!-- Barra de Progreso -->
            <div class="mt-8">
                <div class="text-center text-gray-600 font-semibold mb-2">Progreso Diario</div>
                <div id="progress-bar" class="w-full h-8 rounded-full bg-gray-200">
                    <div id="progress-bar-fill" class="h-full rounded-full bg-green-500 transition-all duration-500" style="width: 0%;"></div>
                </div>
            </div>
        </div>

        <!-- Vista de Recompensas -->
        <div id="rewards-view" class="hidden">
            <h2 class="text-2xl font-bold text-gray-700 mb-4">Mis Recompensas</h2>
            <div id="rewards-container" class="grid grid-cols-3 gap-4">
                <!-- Las recompensas se renderizarán aquí -->
            </div>
        </div>

        <!-- Vista de Configuración del Cuidador -->
        <div id="settings-view" class="hidden">
            <h2 class="text-2xl font-bold text-gray-700 mb-4">Configuración del Cuidador</h2>
            <p class="text-sm text-gray-500 mb-4" id="current-user-id"></p>
            
            <!-- Sección de Personalización -->
            <form id="add-child-form" class="bg-gray-50 p-4 rounded-xl shadow-inner mb-6">
                <h3 class="font-bold text-xl text-gray-700 mb-2">Personalizar</h3>
                <div class="mb-4">
                    <label for="child-name-input" class="block font-medium text-gray-600 mb-1">Nombre del Niño/a</label>
                    <input type="text" id="child-name-input" placeholder="Ej: Sofía" class="w-full p-2 border border-gray-300 rounded-lg">
                </div>
                <div class="mb-4">
                    <label for="child-avatar-select" class="block font-medium text-gray-600 mb-1">Elegir Avatar</label>
                    <select id="child-avatar-select" class="w-full p-2 border border-gray-300 rounded-lg"></select>
                </div>
                <button type="button" id="save-settings-btn" class="w-full bg-blue-500 text-white font-bold py-2 rounded-lg hover:bg-blue-600 transition-colors">Guardar Cambios</button>
            </form>
            
            <!-- Sección de Tareas -->
            <div class="bg-gray-50 p-4 rounded-xl shadow-inner mb-6">
                <h3 class="font-bold text-xl text-gray-700 mb-2">Gestión de Tareas</h3>
                <form id="add-task-form" class="flex items-center space-x-2">
                    <input type="text" id="add-task-input" placeholder="Añadir una nueva tarea" class="flex-1 p-2 border border-gray-300 rounded-lg">
                    <button type="submit" id="add-task-btn" class="bg-green-500 text-white p-2 rounded-lg hover:bg-green-600 transition-colors">Añadir</button>
                </form>
            </div>
            
            <!-- Funciones Extra -->
            <div class="bg-gray-50 p-4 rounded-xl shadow-inner">
                <h3 class="font-bold text-xl text-gray-700 mb-2">Herramientas Extra</h3>
                <div class="grid grid-cols-2 sm:grid-cols-2 gap-4">
                    <button id="print-btn" class="bg-purple-500 text-white font-bold py-2 rounded-lg hover:bg-purple-600 transition-colors caregiver-tool hidden">Imprimir Rutina</button>
                    <button id="narrate-btn" class="bg-yellow-500 text-white font-bold py-2 rounded-lg hover:bg-yellow-600 transition-colors">Narrar Tareas</button>
                    <button id="night-mode-toggle" class="bg-gray-700 text-white font-bold py-2 rounded-lg hover:bg-gray-800 transition-colors">Modo Noche</button>
                    <button id="toggle-caregiver-tools" class="bg-red-500 text-white font-bold py-2 rounded-lg hover:bg-red-600 transition-colors">Modo Cuidador</button>
                </div>
            </div>
        </div>

        <div id="confetti-container" class="confetti-container"></div>
    </div>
</body>
</html>
