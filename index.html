import React from 'react';
import { create } from 'zustand';
import { persist, createJSONStorage } from 'zustand/middleware';
import { motion, AnimatePresence } from 'framer-motion';

// --- TIPOS DE DATOS (TYPESCRIPT) ---
// Define la estructura de nuestros datos para más seguridad y claridad.
type Task = {
  id: string;
  title: string;
  imageUrl: string;
  stars: number;
  status: "pending" | "done";
  kidId: string;
  schedule?: "daily" | "weekly" | null;
};

type Reward = {
  id: string;
  title: string;
  imageUrl: string;
  costStars: number;
  lowCost: boolean;
  description?: string;
};

type Kid = {
  id: string;
  name: string;
  avatarUrl: string;
  stars: number;
};

type Settings = {
  soundOn: boolean;
  language: 'es' | 'en';
  pin: string | null;
};

// --- ESTADO GLOBAL CON ZUSTAND ---
// Zustand maneja todo el estado de nuestra aplicación de forma centralizada.
// Usamos `persist` para guardar y cargar automáticamente el estado desde localStorage.
interface AppState {
  kids: Kid[];
  tasks: Task[];
  rewards: Reward[];
  settings: Settings;
  currentKidId: string | null;
  currentPage: string;
  actions: {
    addKid: (name: string, avatarUrl: string) => void;
    setCurrentKidId: (id: string | null) => void;
    importDefaults: (kidId: string) => void;
    completeTask: (taskId: string) => void;
    redeemReward: (rewardId: string) => boolean;
    setPin: (pin: string) => void;
    toggleSound: () => void;
    setPage: (page: string) => void;
    addTask: (task: Omit<Task, 'id' | 'status'>) => void;
    deleteTask: (taskId: string) => void;
    addReward: (reward: Omit<Reward, 'id'>) => void;
    deleteReward: (rewardId: string) => void;
  };
}

const useAppStore = create<AppState>()(
  persist(
    (set, get) => ({
      kids: [],
      tasks: [],
      rewards: [],
      settings: { soundOn: true, language: 'es', pin: null },
      currentKidId: null,
      currentPage: '/', // Default to home, logic will show onboarding if needed
      actions: {
        addKid: (name, avatarUrl) => {
          const newKid: Kid = { id: `kid_${Date.now()}`, name, avatarUrl, stars: 0 };
          set((state) => ({ kids: [...state.kids, newKid] }));
          get().actions.setCurrentKidId(newKid.id);
          get().actions.importDefaults(newKid.id);
          get().actions.setPage('/'); // Go to home screen after adding a kid
        },
        setCurrentKidId: (id) => set({ currentKidId: id }),
        importDefaults: (kidId) => {
          // Packs de datos iniciales
          const defaultTasks = [
            { title: "Cepillar dientes", imageUrl: "https://placehold.co/400x400/bef264/44403c?text=Dientes", stars: 1, schedule: "daily" },
            { title: "Guardar juguetes", imageUrl: "https://placehold.co/400x400/a5b4fc/44403c?text=Juguetes", stars: 1, schedule: "daily" },
            { title: "Poner la mesa", imageUrl: "https://placehold.co/400x400/fca5a5/44403c?text=Mesa", stars: 1, schedule: "daily" },
            { title: "Lavarse manos", imageUrl: "https://placehold.co/400x400/7dd3fc/44403c?text=Manos", stars: 1, schedule: "daily" },
            { title: "Decir gracias", imageUrl: "https://placehold.co/400x400/f9a8d4/44403c?text=Gracias", stars: 1, schedule: "daily" }
          ];
          const defaultRewards = [
            { title: "Elegir el cuento", imageUrl: "https://placehold.co/400x400/fde047/44403c?text=Cuento", costStars: 3, lowCost: true },
            { title: "Picnic en el living", imageUrl: "https://placehold.co/400x400/a7f3d0/44403c?text=Picnic", costStars: 4, lowCost: true },
            { title: "10 min de baile", imageUrl: "https://placehold.co/400x400/d8b4fe/44403c?text=Baile", costStars: 2, lowCost: true },
            { title: "Elegir canción del auto", imageUrl: "https://placehold.co/400x400/fdba74/44403c?text=Música", costStars: 1, lowCost: true },
            { title: "Hora de manualidades", imageUrl: "https://placehold.co/400x400/f9a8d4/44403c?text=Arte", costStars: 5, lowCost: true }
          ];

          const newTasks = defaultTasks.map((task, i) => ({
            ...task,
            id: `task_${Date.now()}_${i}`,
            status: 'pending',
            kidId: kidId,
          } as Task));

          const newRewards = defaultRewards.map((reward, i) => ({
            ...reward,
            id: `reward_${Date.now()}_${i}`,
          } as Reward));

          set({ tasks: newTasks, rewards: newRewards });
        },
        completeTask: (taskId) => {
          set((state) => {
            let starsToAdd = 0;
            const updatedTasks = state.tasks.map(t => {
              if (t.id === taskId && t.status === 'pending') {
                starsToAdd = t.stars;
                return { ...t, status: 'done' };
              }
              return t;
            });

            if (starsToAdd > 0) {
              const updatedKids = state.kids.map(k =>
                k.id === state.currentKidId ? { ...k, stars: k.stars + starsToAdd } : k
              );
              return { tasks: updatedTasks, kids: updatedKids };
            }
            return { tasks: updatedTasks };
          });
        },
        redeemReward: (rewardId) => {
            const kid = get().kids.find(k => k.id === get().currentKidId);
            const reward = get().rewards.find(r => r.id === rewardId);
            if (kid && reward && kid.stars >= reward.costStars) {
                set((state) => ({
                    kids: state.kids.map(k =>
                        k.id === state.currentKidId ? { ...k, stars: k.stars - reward.costStars } : k
                    ),
                }));
                return true;
            }
            return false;
        },
        setPin: (pin) => set(state => ({ settings: { ...state.settings, pin } })),
        toggleSound: () => set(state => ({ settings: { ...state.settings, soundOn: !state.settings.soundOn } })),
        setPage: (page) => set({ currentPage: page }),
        addTask: (task) => {
          const newTask = { ...task, id: `task_custom_${Date.now()}`, status: 'pending' } as Task;
          set(state => ({ tasks: [...state.tasks, newTask]}));
        },
        deleteTask: (taskId) => {
          set(state => ({ tasks: state.tasks.filter(t => t.id !== taskId) }));
        },
        addReward: (reward) => {
            const newReward = { ...reward, id: `reward_custom_${Date.now()}` } as Reward;
            set(state => ({ rewards: [...state.rewards, newReward] }));
        },
        deleteReward: (rewardId) => {
            set(state => ({ rewards: state.rewards.filter(r => r.id !== rewardId) }));
        },
      },
    }),
    {
      name: 'mi-pequeno-mundo-storage',
      storage: createJSONStorage(() => localStorage),
      partialize: (state) => ({
        kids: state.kids,
        tasks: state.tasks,
        rewards: state.rewards,
        settings: state.settings,
        currentKidId: state.currentKidId,
      }),
    }
  )
);

// --- COMPONENTES DE UI ---

const BigButton = ({ children, onClick, className = '' }) => (
  <button
    onClick={onClick}
    className={`w-full min-h-[56px] text-xl font-bold text-white bg-pink-500 hover:bg-pink-600 rounded-2xl shadow-lg transition-transform transform hover:scale-105 ${className}`}
  >
    {children}
  </button>
);

const TaskCard = ({ task, onClick }) => (
  <motion.div
    layout
    initial={{ scale: 0.8, opacity: 0 }}
    animate={{ scale: 1, opacity: 1 }}
    exit={{ scale: 0.8, opacity: 0 }}
    transition={{ type: 'spring', stiffness: 260, damping: 20 }}
    onClick={onClick}
    className="relative aspect-square w-full bg-white rounded-2xl shadow-md cursor-pointer overflow-hidden transform hover:-translate-y-1 transition-transform"
  >
    <img src={task.imageUrl} alt={task.title} className="w-full h-full object-cover" />
    <div className="absolute inset-0 bg-black bg-opacity-30 flex items-end p-3">
      <h3 className="text-white text-lg font-bold">{task.title}</h3>
    </div>
    {task.status === 'done' && (
      <div className="absolute inset-0 bg-green-500 bg-opacity-70 flex items-center justify-center">
        <svg xmlns="http://www.w3.org/2000/svg" className="h-20 w-20 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" />
        </svg>
      </div>
    )}
  </motion.div>
);

const RewardCard = ({ reward, onClick, canAfford }) => (
    <div
        onClick={canAfford ? onClick : null}
        className={`relative aspect-square w-full bg-white rounded-2xl shadow-md overflow-hidden transition-all ${canAfford ? 'cursor-pointer hover:shadow-xl hover:-translate-y-1' : 'opacity-50'}`}
    >
        <img src={reward.imageUrl} alt={reward.title} className="w-full h-full object-cover" />
        <div className="absolute inset-x-0 bottom-0 bg-black bg-opacity-40 p-3 text-white">
            <h3 className="font-bold text-lg">{reward.title}</h3>
            <div className="flex items-center gap-1 text-yellow-300 font-bold">
                <span>{reward.costStars}</span>
                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                </svg>
            </div>
        </div>
        {!canAfford && <div className="absolute inset-0 bg-gray-700 bg-opacity-60"></div>}
    </div>
);


const TaskModal = ({ task, onComplete, onCancel }) => (
  <motion.div
    initial={{ opacity: 0 }}
    animate={{ opacity: 1 }}
    exit={{ opacity: 0 }}
    className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50"
  >
    <motion.div
      initial={{ scale: 0.8, y: 50 }}
      animate={{ scale: 1, y: 0 }}
      exit={{ scale: 0.8, y: 50 }}
      className="bg-white rounded-3xl shadow-2xl w-full max-w-sm mx-auto overflow-hidden"
    >
      <div className="aspect-square w-full">
         <img src={task.imageUrl} alt={task.title} className="w-full h-full object-cover" />
      </div>
      <div className="p-6 text-center">
        <h2 className="text-3xl font-bold text-gray-800 mb-4">{task.title}</h2>
        <div className="flex flex-col gap-3">
          <BigButton onClick={onComplete} className="bg-green-500 hover:bg-green-600">¡Hecho!</BigButton>
          <BigButton onClick={onCancel} className="bg-gray-300 text-gray-700 hover:bg-gray-400">Cancelar</BigButton>
        </div>
      </div>
    </motion.div>
  </motion.div>
);

const RedeemModal = ({ reward, onRedeem, onCancel }) => (
    <motion.div
        initial={{ opacity: 0 }}
        animate={{ opacity: 1 }}
        exit={{ opacity: 0 }}
        className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50"
    >
        <motion.div
            initial={{ scale: 0.8 }}
            animate={{ scale: 1 }}
            exit={{ scale: 0.8 }}
            className="bg-white rounded-3xl shadow-2xl w-full max-w-sm mx-auto overflow-hidden"
        >
            <div className="aspect-square w-full">
                <img src={reward.imageUrl} alt={reward.title} className="w-full h-full object-cover" />
            </div>
            <div className="p-6 text-center">
                <h2 className="text-2xl font-bold text-gray-800">¿Canjear esta recompensa?</h2>
                <p className="text-gray-600 text-lg mb-4">{reward.title}</p>
                 <div className="flex items-center justify-center gap-2 text-yellow-500 font-bold text-2xl mb-4">
                    <span>{reward.costStars}</span>
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-7 w-7" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>
                </div>
                <div className="flex flex-col gap-3">
                    <BigButton onClick={onRedeem} className="bg-blue-500 hover:bg-blue-600">Sí, canjear</BigButton>
                    <BigButton onClick={onCancel} className="bg-gray-300 text-gray-700 hover:bg-gray-400">Ahora no</BigButton>
                </div>
            </div>
        </motion.div>
    </motion.div>
);

const Confetti = () => (
    <div className="fixed inset-0 pointer-events-none z-[100]">
        {[...Array(100)].map((_, i) => (
            <div
                key={i}
                className="absolute w-2 h-4 rounded-full"
                style={{
                    left: `${Math.random() * 100}%`,
                    animation: `confetti-fall ${1 + Math.random() * 2}s linear ${Math.random() * 1}s infinite`,
                    backgroundColor: ['#fde047', '#a7f3d0', '#f9a8d4', '#a5b4fc', '#fca5a5'][Math.floor(Math.random() * 5)],
                }}
            />
        ))}
    </div>
);


// --- PANTALLAS DE LA APLICACIÓN ---

const OnboardingScreen = () => {
  const { addKid } = useAppStore(state => state.actions);
  const [name, setName] = React.useState('');
  const [avatar, setAvatar] = React.useState('https://placehold.co/100x100/a5b4fc/FFFFFF?text=😊');
  const avatars = [
    'https://placehold.co/100x100/a5b4fc/FFFFFF?text=😊', 'https://placehold.co/100x100/f9a8d4/FFFFFF?text=🦄', 
    'https://placehold.co/100x100/a7f3d0/FFFFFF?text=🦖', 'https://placehold.co/100x100/fde047/FFFFFF?text=🦊',
    'https://placehold.co/100x100/fdba74/FFFFFF?text=🦁', 'https://placehold.co/100x100/d8b4fe/FFFFFF?text=🐙'
  ];

  const handleCreate = () => {
    if (name.trim()) {
      addKid(name.trim(), avatar);
    }
  };

  return (
    <div className="min-h-screen bg-yellow-100 flex flex-col items-center justify-center p-4 text-center">
      <motion.div initial={{ scale: 0.8, opacity: 0 }} animate={{ scale: 1, opacity: 1 }} className="w-full max-w-sm">
        <h1 className="text-4xl font-bold text-gray-700 mb-2">¡Bienvenid@s!</h1>
        <p className="text-gray-600 mb-6">Vamos a crear el perfil de tu peque.</p>
        
        <h2 className="text-2xl font-bold text-gray-700 mb-4">1. Elige un avatar</h2>
        <div className="grid grid-cols-3 gap-4 mb-8">
          {avatars.map(av => (
            <img key={av} src={av} onClick={() => setAvatar(av)} alt="avatar" className={`w-24 h-24 rounded-full mx-auto cursor-pointer border-4 ${avatar === av ? 'border-pink-500' : 'border-transparent'}`} />
          ))}
        </div>

        <h2 className="text-2xl font-bold text-gray-700 mb-4">2. ¿Cómo se llama?</h2>
        <input
          type="text"
          value={name}
          onChange={(e) => setName(e.target.value)}
          placeholder="Nombre del peque"
          className="w-full text-center text-xl p-4 rounded-2xl border-2 border-gray-300 focus:border-pink-500 focus:ring-pink-500 mb-8"
        />

        <BigButton onClick={handleCreate}>Crear Perfil y Empezar</BigButton>
      </motion.div>
    </div>
  );
};

const HomeScreen = () => {
  const tasks = useAppStore(state => state.tasks);
  const currentKidId = useAppStore(state => state.currentKidId);
  const { completeTask } = useAppStore(state => state.actions);
  const [selectedTask, setSelectedTask] = React.useState<Task | null>(null);
  const [showConfetti, setShowConfetti] = React.useState(false);
  
  const tasksForKid = tasks.filter(t => t.kidId === currentKidId);
  const pendingTasks = tasksForKid.filter(t => t.status === 'pending');
  const doneTasks = tasksForKid.filter(t => t.status === 'done');

  const handleCompleteTask = () => {
    if (selectedTask) {
      completeTask(selectedTask.id);
      setSelectedTask(null);
      setShowConfetti(true);
      setTimeout(() => setShowConfetti(false), 3000);
    }
  };
  
  return (
    <div className="p-4">
      {showConfetti && <Confetti />}
      <h2 className="text-2xl font-bold text-gray-700 mb-4">Tareas de hoy</h2>
      <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
        {pendingTasks.map(task => <TaskCard key={task.id} task={task} onClick={() => setSelectedTask(task)} />)}
      </div>
       {doneTasks.length > 0 && (
         <>
            <h2 className="text-2xl font-bold text-gray-700 mt-8 mb-4">¡Ya completadas!</h2>
            <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 opacity-60">
                {doneTasks.map(task => <TaskCard key={task.id} task={task} onClick={() => {}} />)}
            </div>
         </>
       )}

      <AnimatePresence>
        {selectedTask && <TaskModal task={selectedTask} onComplete={handleCompleteTask} onCancel={() => setSelectedTask(null)} />}
      </AnimatePresence>
    </div>
  );
};

const RewardsScreen = () => {
    const rewards = useAppStore(state => state.rewards);
    const kids = useAppStore(state => state.kids);
    const currentKidId = useAppStore(state => state.currentKidId);
    const { redeemReward } = useAppStore(state => state.actions);
    const [selectedReward, setSelectedReward] = React.useState<Reward | null>(null);
    const [showRedeemMessage, setShowRedeemMessage] = React.useState('');
    const currentKid = kids.find(k => k.id === currentKidId);

    const handleRedeem = () => {
        if (selectedReward && currentKid) {
            const success = redeemReward(selectedReward.id);
            if(success) {
                setShowRedeemMessage('¡Recompensa canjeada! ¡Qué bien!');
            } else {
                setShowRedeemMessage('Ups, aún no tienes suficientes estrellas.');
            }
            setSelectedReward(null);
            setTimeout(() => setShowRedeemMessage(''), 3000);
        }
    }

    return (
        <div className="p-4">
            <h2 className="text-2xl font-bold text-gray-700 mb-4">Catálogo de Recompensas</h2>
             {showRedeemMessage && (
                <div className="bg-blue-200 text-blue-800 p-4 rounded-lg mb-4 text-center font-bold">
                    {showRedeemMessage}
                </div>
            )}
            <div className="grid grid-cols-2 sm:grid-cols-3 gap-4">
                {rewards.map(reward => (
                    <RewardCard
                        key={reward.id}
                        reward={reward}
                        onClick={() => setSelectedReward(reward)}
                        canAfford={currentKid ? currentKid.stars >= reward.costStars : false}
                    />
                ))}
            </div>
            <AnimatePresence>
                {selectedReward && (
                    <RedeemModal
                        reward={selectedReward}
                        onRedeem={handleRedeem}
                        onCancel={() => setSelectedReward(null)}
                    />
                )}
            </AnimatePresence>
        </div>
    );
};

const AdultPanelScreen = () => {
    const pin = useAppStore(state => state.settings.pin);
    const { setPin } = useAppStore(state => state.actions);
    const [enteredPin, setEnteredPin] = React.useState('');
    const [isAuthenticated, setIsAuthenticated] = React.useState(!pin);

    const handlePinSet = () => {
        if(enteredPin.length === 4) {
            setPin(enteredPin);
            setIsAuthenticated(true);
        }
    };
    
    const handlePinCheck = () => {
         if(enteredPin === pin) {
            setIsAuthenticated(true);
        } else {
            alert('PIN incorrecto');
            setEnteredPin('');
        }
    };
    
    if(!isAuthenticated) {
        return (
             <div className="p-8 text-center">
                <h2 className="text-3xl font-bold mb-4">{pin ? 'Ingresa tu PIN de adulto' : 'Crea un PIN de 4 dígitos'}</h2>
                <input
                    type="password"
                    maxLength="4"
                    value={enteredPin}
                    onChange={(e) => setEnteredPin(e.target.value)}
                    className="w-48 text-center text-4xl p-4 tracking-[1em] rounded-2xl border-2 mb-6"
                />
                <BigButton onClick={pin ? handlePinCheck : handlePinSet}>
                    {pin ? 'Desbloquear' : 'Guardar PIN'}
                </BigButton>
            </div>
        )
    }

    return (
        <div className="p-6">
            <h2 className="text-3xl font-bold mb-6">Panel de Adulto</h2>
            <div className="bg-white p-6 rounded-2xl shadow-md">
                <h3 className="text-xl font-bold mb-4">Ajustes</h3>
                <p>Aquí podrías editar tareas, recompensas, cambiar el PIN y más.</p>
                <button onClick={() => setIsAuthenticated(false)} className="mt-4 bg-gray-200 p-3 rounded-lg">Bloquear Panel</button>
            </div>
        </div>
    );
}

const MainApp = () => {
    const { kids, currentKidId, currentPage, actions } = useAppStore(state => ({
        kids: state.kids,
        currentKidId: state.currentKidId,
        currentPage: state.currentPage,
        actions: state.actions,
    }));

    // This effect ensures a kid is always selected if any exist.
    React.useEffect(() => {
        if (kids.length > 0 && !currentKidId) {
            actions.setCurrentKidId(kids[0].id);
        }
    }, [kids, currentKidId, actions]);

    const currentKid = kids.find(k => k.id === currentKidId);

    if (!currentKid) {
        return <div className="min-h-screen flex items-center justify-center bg-yellow-50"><p>Cargando perfil...</p></div>;
    }

    const renderPage = () => {
        switch (currentPage) {
            case '/': return <HomeScreen />;
            case '/rewards': return <RewardsScreen />;
            case '/adult': return <AdultPanelScreen />;
            default: return <HomeScreen />; // Default to home
        }
    };

    return (
        <div className="max-w-4xl mx-auto bg-yellow-50 min-h-screen font-sans">
            <header className="sticky top-0 bg-white/80 backdrop-blur-sm shadow-sm p-4 flex justify-between items-center z-40">
                <div className="flex items-center gap-3">
                    <img src={currentKid.avatarUrl} alt="Avatar" className="w-12 h-12 rounded-full border-2 border-pink-400" />
                    <div>
                        <h1 className="font-bold text-lg text-gray-800">{currentKid.name}</h1>
                        <div className="flex items-center gap-1 text-yellow-500 font-bold">
                            <span>{currentKid.stars}</span>
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                               <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                            </svg>
                        </div>
                    </div>
                </div>
                <button onClick={() => actions.setPage('/adult')} className="p-2 rounded-full hover:bg-gray-200">
                     <svg xmlns="http://www.w3.org/2000/svg" className="h-7 w-7 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0 3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                </button>
            </header>
            <main className="pb-24">{renderPage()}</main>
            <nav className="fixed bottom-0 left-0 right-0 max-w-4xl mx-auto bg-white shadow-[0_-2px_10px_rgba(0,0,0,0.1)] rounded-t-2xl p-2 flex justify-around items-center">
                 <button onClick={() => actions.setPage('/')} className={`flex flex-col items-center gap-1 p-2 rounded-lg ${currentPage === '/' ? 'text-pink-500' : 'text-gray-500'}`}>
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-7 w-7" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" /></svg>
                    <span className="text-xs font-bold">Tareas</span>
                </button>
                 <button onClick={() => actions.setPage('/rewards')} className={`flex flex-col items-center gap-1 p-2 rounded-lg ${currentPage === '/rewards' ? 'text-pink-500' : 'text-gray-500'}`}>
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-7 w-7" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M5 5a3 3 0 015.252-2.121l.738.737a.5.5 0 00.708 0l.737-.737A3 3 0 1115 5v2.268a2.5 2.5 0 11-2.5-2.5v-1.25a.5.5 0 00-1 0V5a1.5 1.5 0 103 0V5a2 2 0 10-4 0v2.268a2.5 2.5 0 11-2.5-2.5V3.5a.5.5 0 00-1 0V5a1.5 1.5 0 103 0V5a2 2 0 10-4 0v2.268a2.5 2.5 0 11-2.5-2.5V5zM2.5 10a.5.5 0 000 1h15a.5.5 0 000-1h-15z" clipRule="evenodd" /></svg>
                    <span className="text-xs font-bold">Premios</span>
                </button>
            </nav>
        </div>
    );
}

// --- COMPONENTE RAÍZ ---
const App = () => {
  // We only check if kids exist. This value is stable and won't cause re-renders unless a kid is added/removed.
  const kidsExist = useAppStore((state) => state.kids.length > 0);

  // If there are no kids, show the onboarding screen.
  // Otherwise, show the main application.
  return kidsExist ? <MainApp /> : <OnboardingScreen />;
};


export default App;

