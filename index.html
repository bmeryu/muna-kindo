<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Rutina Divertida</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        /* Diseño 2025 */
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #F8F9FA; /* Un blanco más suave */
            color: #212529; /* Negro suave */
        }
        .modern-card {
            background-color: #FFFFFF;
            border-radius: 1.25rem; /* 20px */
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.07), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            border: 1px solid #E5E7EB;
            transition: all 0.3s ease;
        }
        .modern-button {
            border-radius: 0.75rem; /* 12px */
            font-weight: 700;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        }
        .modern-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .modern-button-primary {
            background-color: #3B82F6; /* Azul Vibrante */
            color: white;
        }
        .modern-button-secondary {
            background-color: #E5E7EB;
            color: #374151;
        }

        .task-checkbox:checked + label { text-decoration: line-through; color: #9CA3AF; }
        .task-checkbox:checked + label svg.icon-unchecked { display: none; }
        .task-checkbox:checked + label svg.icon-checked { display: inline-block; }
        .progress-bar-fill { transition: width 0.5s ease-in-out; }

        /* Modo Noche */
        .dark-mode { background-color: #111827; color: #F9FAFB; }
        .dark-mode .modern-card { background-color: #1F2937; border-color: #374151; }
        .dark-mode .modern-button-secondary { background-color: #374151; color: #F9FAFB; }
        .dark-mode .text-gray-800 { color: #F9FAFB; } .dark-mode .text-gray-500 { color: #9CA3AF; }
        .dark-mode .text-amber-500 { color: #FBBF24; }
        .dark-mode .bg-blue-100 { background-color: #1E40AF; }
        .dark-mode .bg-green-100 { background-color: #065F46; }
        .dark-mode .bg-purple-100 { background-color: #5B21B6; }
        .dark-mode .day-selector.bg-white { background-color: #374151; }
        .dark-mode .bg-gray-100, .dark-mode .bg-gray-50 { background-color: #374151; }
        .dark-mode #settings-modal input, .dark-mode #setup-modal input, .dark-mode #setup-modal select, .dark-mode #new-task-AM, .dark-mode #new-task-PM, .dark-mode #new-task-Noche { background-color: #4B5563; border-color: #6B7280; color: #F9FAFB; }
        .dark-mode .task-item { background-color: #4B5563;}

        
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .task-item, .reward-item { animation: fadeIn 0.3s ease-out; }
        .dragging { opacity: 0.5; background-color: #FEF3C7; }
        .drag-over { border-top: 2px dashed #3B82F6; }
    </style>
</head>
<body class="transition-colors duration-500">

    <div id="app" class="max-w-5xl mx-auto p-4 md:p-6"></div>

    <!-- Modals -->
    <div id="setup-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="modern-card p-6 md:p-8 w-full max-w-md text-center">
            <h2 class="text-2xl md:text-3xl font-bold text-blue-500 mb-4">¡Bienvenido/a!</h2>
            <p class="text-gray-500 mb-6">Vamos a configurar tu rutina divertida.</p>
            <div class="mb-4 text-left">
                <label for="child-name" class="block font-bold mb-2">Nombre del niño/a:</label>
                <input type="text" id="child-name" placeholder="Ej: Leo" class="w-full p-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition-colors">
            </div>
            <div class="mb-4 text-left">
                <label class="block font-bold mb-2">Elige un avatar:</label>
                <div id="avatar-selection" class="flex justify-center flex-wrap gap-4"></div>
            </div>
            <div class="mb-6 text-left">
                <label for="routine-select" class="block font-bold mb-2">Elige una rutina base:</label>
                <select id="routine-select" class="w-full p-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none bg-white">
                    <option value="toddler">Pequeños (2-3 años)</option>
                    <option value="preschooler">Grandes (4-5 años)</option>
                </select>
            </div>
            <button id="start-button" class="modern-button modern-button-primary py-3 px-8 text-lg w-full">¡Empezar a Jugar!</button>
        </div>
    </div>
    
    <div id="rewards-store-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50 no-print">
        <div class="modern-card p-6 md:p-8 w-full max-w-2xl text-center relative max-h-[90vh] flex flex-col">
            <button class="close-modal-btn absolute top-4 right-4 text-gray-400 hover:text-gray-800 text-3xl font-bold">&times;</button>
            <h2 class="text-2xl md:text-3xl font-bold text-blue-500 mb-2">Tienda de Recompensas</h2>
            <p class="text-gray-500 mb-6">¡Usa tus estrellas para conseguir premios geniales!</p>
            <div id="rewards-store-grid" class="grid grid-cols-2 sm:grid-cols-3 gap-4 overflow-y-auto p-4 bg-gray-50 rounded-lg"></div>
        </div>
    </div>
    
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50 no-print">
         <div class="modern-card p-6 md:p-8 w-full max-w-lg text-center relative max-h-[90vh] flex flex-col">
            <button class="close-modal-btn absolute top-4 right-4 text-gray-400 hover:text-gray-800 text-3xl font-bold">&times;</button>
            <h2 class="text-2xl md:text-3xl font-bold text-blue-500 mb-4">Ajustes</h2>
            <div class="text-left overflow-y-auto">
                <h3 class="font-bold text-lg mb-2">Gestionar Recompensas de la Tienda</h3>
                <div class="bg-gray-100 p-4 rounded-lg mb-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-2 items-end">
                        <div class="flex flex-col"><label for="reward-text" class="text-sm font-bold">Nombre</label><input type="text" id="reward-text" class="p-2 rounded border" placeholder="30 min. de tablet"></div>
                        <div class="flex flex-col"><label for="reward-icon" class="text-sm font-bold">Icono</label><input type="text" id="reward-icon" class="p-2 rounded border" placeholder="📱"></div>
                        <div class="flex flex-col"><label for="reward-cost" class="text-sm font-bold">Coste (🌟)</label><input type="number" id="reward-cost" class="p-2 rounded border" placeholder="20"></div>
                    </div>
                     <button id="add-reward-btn" class="modern-button modern-button-primary w-full mt-3 py-2">Añadir Recompensa</button>
                </div>
                <div id="custom-rewards-list"></div>
            </div>
        </div>
    </div>
    
    <!-- Other Modals (Library, Copy, Logout) -->
    <div id="library-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50 no-print"> <div class="modern-card p-6 md:p-8 w-full max-w-2xl relative max-h-[90vh] flex flex-col"><button class="close-modal-btn absolute top-4 right-4 text-gray-400 hover:text-gray-800 text-3xl font-bold">&times;</button><h2 class="text-2xl md:text-3xl font-bold text-blue-500 mb-4 text-center">Biblioteca de Tareas</h2><div id="library-content" class="overflow-y-auto text-left"></div></div></div>
    <div id="copy-routine-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50 no-print"><div class="modern-card p-6 md:p-8 w-full max-w-md text-center"><button class="close-modal-btn absolute top-4 right-4 text-gray-400 hover:text-gray-800 text-3xl font-bold">&times;</button><h2 class="text-xl md:text-2xl font-bold text-blue-500 mb-4">Copiar Rutina del <span id="copy-day-name"></span></h2><p class="text-gray-500 mb-6">Selecciona los días a los que quieres copiar esta rutina.</p><div id="copy-days-selection" class="grid grid-cols-2 gap-4 text-left mb-6"></div><button id="confirm-copy-btn" class="modern-button modern-button-primary py-2 px-6">Copiar</button></div></div>
    <div id="logout-confirm-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50 no-print"><div class="modern-card p-6 md:p-8 w-full max-w-sm text-center"><h2 class="text-xl md:text-2xl font-bold text-red-500 mb-4">¿Cerrar Sesión?</h2><p class="text-gray-500 mb-6">Se borrarán todos los datos. ¿Estás seguro?</p><div class="flex justify-center space-x-4"><button id="confirm-logout-btn" class="modern-button bg-red-500 text-white py-2 px-6">Sí, cerrar</button><button id="cancel-logout-btn" class="modern-button modern-button-secondary py-2 px-6">Cancelar</button></div></div></div>

    <div id="notification-modal" class="fixed top-5 right-5 bg-green-500 text-white p-4 rounded-lg shadow-lg transform translate-x-[calc(100%+1.25rem)] transition-transform duration-500 z-50 no-print"><p id="notification-text" class="font-bold"></p></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const $ = (selector) => document.querySelector(selector);
            const $$ = (selector) => document.querySelectorAll(selector);

            const modals = {
                setup: $('#setup-modal'),
                rewardsStore: $('#rewards-store-modal'),
                library: $('#library-modal'),
                logout: $('#logout-confirm-modal'),
                copy: $('#copy-routine-modal'),
                settings: $('#settings-modal'),
            };

            const synth = window.speechSynthesis;
           
            const avatars = { bunny: { name: 'Conejito', emoji: '🐰' }, bear: { name: 'Osito', emoji: '🐻' }, monster: { name: 'Monstruito', emoji: '👾' }, dino: { name: 'Dinosaurio', emoji: '🦖' }, fox: { name: 'Zorro', emoji: '🦊' }, panda: { name: 'Panda', emoji: '🐼' } };
            const daysOfWeek = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado', 'Domingo'];
            let state = {};
            let draggedTask = null;

            // --- DATA & STATE ---
            function generateTaskLibrary() {
                const lib = {
                    higiene: [ { text: 'Ir al baño', img: 'https://static.arasaac.org/pictograms/2959/2959_300.png' }, { text: 'Lavarse las manos', img: 'https://static.arasaac.org/pictograms/3236/3236_300.png' }, { text: 'Lavarse los dientes', img: 'https://static.arasaac.org/pictograms/3235/3235_300.png' }, { text: 'Peinarse', img: 'https://static.arasaac.org/pictograms/3241/3241_300.png' }, { text: 'Ducharse o bañarse', img: 'https://static.arasaac.org/pictograms/2439/2439_300.png' } ],
                    vestimenta: [ { text: 'Vestirse', img: 'https://static.arasaac.org/pictograms/3245/3245_300.png' }, { text: 'Ponerse el pijama', img: 'https://static.arasaac.org/pictograms/3326/3326_300.png' }, { text: 'Elegir la ropa', img: 'https://static.arasaac.org/pictograms/30739/30739_300.png' }, { text: 'Ponerse los zapatos', img: 'https://static.arasaac.org/pictograms/3248/3248_300.png' }, { text: 'Ropa sucia al cesto', img: 'https://static.arasaac.org/pictograms/4572/4572_300.png' } ],
                    comidas: [ { text: 'Desayunar', img: 'https://static.arasaac.org/pictograms/2419/2419_300.png' }, { text: 'Comer', img: 'https://static.arasaac.org/pictograms/2364/2364_300.png' }, { text: 'Tomar la merienda', img: 'https://static.arasaac.org/pictograms/3277/3277_300.png' }, { text: 'Cenar', img: 'https://static.arasaac.org/pictograms/2320/2320_300.png' }, { text: 'Poner la mesa', img: 'https://static.arasaac.org/pictograms/3333/3333_300.png' }, { text: 'Beber agua', img: 'https://static.arasaac.org/pictograms/2289/2289_300.png' } ],
                    responsabilidades: [ { text: 'Ordenar los juguetes', img: 'https://static.arasaac.org/pictograms/3349/3349_300.png' }, { text: 'Hacer la cama', img: 'https://static.arasaac.org/pictograms/2686/2686_300.png' }, { text: 'Comida de la mascota', img: 'https://static.arasaac.org/pictograms/3267/3267_300.png' }, { text: 'Regar las plantas', img: 'https://static.arasaac.org/pictograms/3350/3350_300.png' } ],
                    calmaYDescanso: [ { text: 'Leer un cuento', img: 'https://static.arasaac.org/pictograms/3108/3108_300.png' }, { text: 'Momento de calma', img: 'https://static.arasaac.org/pictograms/7041/7041_300.png' }, { text: 'Escuchar música', img: 'https://static.arasaac.org/pictograms/2549/2549_300.png' }, { text: 'Abrazar', img: 'https://static.arasaac.org/pictograms/2244/2244_300.png' }, { text: 'Ir a dormir', img: 'https://static.arasaac.org/pictograms/2434/2434_300.png' }, { text: 'Despertar', img: 'https://static.arasaac.org/pictograms/2420/2420_300.png' } ],
                    juegoYAprendizaje: [ { text: 'Jugar', img: 'https://static.arasaac.org/pictograms/2898/2898_300.png' }, { text: 'Hacer manualidades', img: 'https://static.arasaac.org/pictograms/2795/2795_300.png' }, { text: 'Jugar afuera', img: 'https://static.arasaac.org/pictograms/3201/3201_300.png' }, { text: 'Hacer los deberes', img: 'https://static.arasaac.org/pictograms/2425/2425_300.png' } ]
                };
                Object.values(lib).forEach(category => category.forEach(task => { task.stars = 1; }));
                return lib;
            }
            const taskLibrary = generateTaskLibrary();

            const routines = {
                toddler: { AM: [ taskLibrary.calmaYDescanso[5], taskLibrary.higiene[0], taskLibrary.higiene[2], taskLibrary.vestimenta[0], taskLibrary.comidas[0] ], PM: [ taskLibrary.comidas[1], taskLibrary.juegoYAprendizaje[0], taskLibrary.responsabilidades[0], taskLibrary.comidas[2] ], Noche: [ taskLibrary.comidas[3], taskLibrary.vestimenta[1], taskLibrary.higiene[2], taskLibrary.calmaYDescanso[0], taskLibrary.calmaYDescanso[4] ] },
                preschooler: { AM: [ taskLibrary.responsabilidades[1], taskLibrary.higiene[0], taskLibrary.higiene[2], taskLibrary.vestimenta[0], taskLibrary.comidas[0] ], PM: [ taskLibrary.comidas[1], taskLibrary.juegoYAprendizaje[3], taskLibrary.responsabilidades[0] ], Noche: [ taskLibrary.comidas[3], taskLibrary.vestimenta[1], taskLibrary.higiene[2], taskLibrary.calmaYDescanso[0], taskLibrary.calmaYDescanso[4] ] }
            };

            function resetState() { state = { childName: '', avatar: 'bunny', currentDay: new Date().toLocaleDateString('es-ES', { weekday: 'long' }).replace(/^\w/, c => c.toUpperCase()), darkMode: false, tasks: {}, starBalance: 0, customRewards: [] }; }
            function saveState() { localStorage.setItem('miRutinaDivertida_v2', JSON.stringify(state)); }
            function loadState() {
                const savedState = localStorage.getItem('miRutinaDivertida_v2');
                if (savedState) {
                    state = JSON.parse(savedState);
                    if (state.customRewards === undefined) { state.customRewards = []; }
                    if (state.starBalance === undefined) { state.starBalance = 0; }

                    // --- MIGRATION LOGIC ---
                    if (state.tasks && Object.keys(state.tasks).length > 0) {
                        const migrationMap = {
                            'Ir al baño y tirar la cadena': { text: 'Ir al baño', img: 'https://static.arasaac.org/pictograms/2959/2959_300.png' },
                            'Lavarse las manos con jabón': { text: 'Lavarse las manos', img: 'https://static.arasaac.org/pictograms/3236/3236_300.png' },
                            'Peinarse el pelo': { text: 'Peinarse', img: 'https://static.arasaac.org/pictograms/3241/3241_300.png' },
                            'Darse un baño o ducha': { text: 'Ducharse o bañarse', img: 'https://static.arasaac.org/pictograms/2439/2439_300.png' },
                            'Ponerse la ropa de día': { text: 'Vestirse', img: 'https://static.arasaac.org/pictograms/3245/3245_300.png' },
                            'Elegir la ropa para mañana': { text: 'Elegir la ropa', img: 'https://static.arasaac.org/pictograms/30739/30739_300.png' },
                            'Poner la ropa sucia en el cesto': { text: 'Ropa sucia al cesto', img: 'https://static.arasaac.org/pictograms/4572/4572_300.png' },
                            'Comer el almuerzo': { text: 'Comer', img: 'https://static.arasaac.org/pictograms/2364/2364_300.png' },
                            'Cenar en familia': { text: 'Cenar', img: 'https://static.arasaac.org/pictograms/2320/2320_300.png' },
                            'Ayudar a poner la mesa': { text: 'Poner la mesa', img: 'https://static.arasaac.org/pictograms/3333/3333_300.png' },
                            'Darle comida a la mascota': { text: 'Comida de la mascota', img: 'https://static.arasaac.org/pictograms/3267/3267_300.png' },
                            'Momento de tranquilidad': { text: 'Momento de calma', img: 'https://static.arasaac.org/pictograms/7041/7041_300.png' },
                            'Escuchar música relajante': { text: 'Escuchar música', img: 'https://static.arasaac.org/pictograms/2549/2549_300.png' },
                            'Abrazos y mimos': { text: 'Abrazar', img: 'https://static.arasaac.org/pictograms/2244/2244_300.png' },
                            'Ir a la cama a descansar': { text: 'Ir a dormir', img: 'https://static.arasaac.org/pictograms/2434/2434_300.png' },
                            'Despertar y estirarse': { text: 'Despertar', img: 'https://static.arasaac.org/pictograms/2420/2420_300.png' },
                            'Jugar libremente': { text: 'Jugar', img: 'https://static.arasaac.org/pictograms/2898/2898_300.png' },
                            'Hacer una manualidad': { text: 'Hacer manualidades', img: 'https://static.arasaac.org/pictograms/2795/2795_300.png' },
                            'Jugar al aire libre': { text: 'Jugar afuera', img: 'https://static.arasaac.org/pictograms/3201/3201_300.png' },
                            'Hacer las tareas de la escuela': { text: 'Hacer los deberes', img: 'https://static.arasaac.org/pictograms/2425/2425_300.png' }
                        };
                        
                        Object.values(state.tasks).forEach(day => {
                            Object.values(day).forEach(periodTasks => {
                                periodTasks.forEach(task => {
                                    if (task.t && task.text === undefined) {
                                        const oldText = task.t;
                                        const migratedTaskData = migrationMap[oldText];
                                        if (migratedTaskData) {
                                            task.text = migratedTaskData.text;
                                            task.img = migratedTaskData.img;
                                        } else {
                                            task.text = oldText;
                                            task.img = 'https://static.arasaac.org/pictograms/2750/2750_300.png'; 
                                        }
                                        delete task.t;
                                        delete task.i;
                                    }
                                });
                            });
                        });
                    }
                    // --- END MIGRATION LOGIC ---

                    if(state.darkMode) document.body.classList.add('dark-mode');
                } 
                else { resetState(); }
            }
            
            // --- INITIALIZATION ---
            function initialize() {
                loadState();
                renderAvatars();
                renderTaskLibrary();
                if (state.childName) { modals.setup.style.display = 'none'; renderApp(); }
                $('#start-button').addEventListener('click', () => {
                    state.childName = $('#child-name').value.trim();
                    if (!state.childName) return;
                    state.avatar = $('input[name="avatar"]:checked').value;
                    if(Object.keys(state.tasks).length === 0) initializeTasksForWeek();
                    modals.setup.style.display = 'none';
                    saveAndRender();
                });
            }
            function initializeTasksForWeek() {
                const selectedRoutine = routines[$('#routine-select').value];
                daysOfWeek.forEach(day => { state.tasks[day] = JSON.parse(JSON.stringify(selectedRoutine)); });
            }

            // --- RENDER FUNCTIONS ---
            function renderApp() {
                const dayTasks = state.tasks[state.currentDay] || routines.toddler;
                const allDayTasks = [...dayTasks.AM, ...dayTasks.PM, ...dayTasks.Noche];
                const progress = allDayTasks.length > 0 ? (allDayTasks.filter(t => t.done).length / allDayTasks.length) * 100 : 0;
                
                $('#app').innerHTML = `
                    <header class="modern-card p-4 mb-6 text-center no-print">
                        <div class="flex justify-between items-center mb-4">
                            <div class="flex items-center gap-2">${Object.keys(avatars).map(key => `<div class="${state.avatar === key ? '' : 'hidden'} text-5xl">${avatars[key].emoji}</div>`).join('')} <div><p class="text-gray-500">Rutina de</p><h1 class="text-2xl font-bold text-gray-800">${state.childName}</h1></div> </div>
                            <div class="flex items-center justify-center bg-amber-100 rounded-full px-4 py-1 shadow-inner"><span class="text-2xl font-bold text-amber-600">${state.starBalance}</span><span class="text-3xl ml-1">🌟</span></div>
                            <div class="flex items-center space-x-2">
                                <button id="rewards-store-btn" class="modern-button bg-white p-3" title="Tienda de Recompensas">🎁</button>
                                <button id="settings-btn" class="modern-button bg-white p-3" title="Ajustes">⚙️</button>
                                <button id="logout-btn" class="modern-button bg-white p-3" title="Cerrar Sesión">🚪</button>
                            </div>
                        </div>
                        <div class="mb-4"><p class="text-gray-500 mb-2 font-semibold">Progreso Semanal:</p><div class="flex justify-center space-x-2">${daysOfWeek.map(day => `<div class="flex flex-col items-center"><span class="text-xs font-bold">${day.substring(0,3)}</span><span class="text-2xl">${isDayComplete(day) ? '🌟' : '⚪'}</span></div>`).join('')}</div></div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5"><div class="bg-blue-500 h-2.5 rounded-full progress-bar-fill" style="width: ${progress}%"></div></div>
                    </header>
                    <div class="flex justify-between items-center mb-6 no-print">
                        <div class="flex space-x-2 overflow-x-auto pb-2">${daysOfWeek.map(day => `<button class="day-selector modern-button text-sm sm:text-base py-2 px-4 whitespace-nowrap ${state.currentDay === day ? 'modern-button-primary' : 'bg-white'}" data-day="${day}">${day}</button>`).join('')}</div>
                        <button id="copy-day-btn" class="modern-button modern-button-secondary p-2 ml-2" title="Copiar rutina del día">📋</button>
                    </div>
                    <main class="grid md:grid-cols-3 gap-6">${renderTaskList('AM', 'Mañana', dayTasks.AM)} ${renderTaskList('PM', 'Tarde', dayTasks.PM)} ${renderTaskList('Noche', 'Noche', dayTasks.Noche)}</main>`;
                addEventListeners();
            }

            function renderTaskList(period, title, tasks) {
                const colors = { AM: 'bg-blue-100', PM: 'bg-green-100', Noche: 'bg-purple-100' };
                return `
                    <div class="modern-card p-4 flex flex-col">
                        <h2 class="text-xl font-extrabold text-center mb-4 ${colors[period]} rounded-lg py-2">${title}</h2>
                        <ul class="space-y-3 task-list flex-grow" data-period="${period}">${tasks.map((task, index) => renderTaskItem(task, period, index)).join('')}</ul>
                        <div class="mt-4"><div class="flex space-x-2"><input type="text" id="new-task-${period}" class="w-full p-2 border-2 border-gray-200 rounded-lg" placeholder="Nueva tarea..."><button class="add-task-btn modern-button modern-button-primary px-4" data-period="${period}">+</button></div><button class="open-library-btn modern-button modern-button-secondary w-full mt-2 py-2" data-period="${period}">Añadir de Biblioteca</button></div>
                    </div>`;
            }
            function renderTaskItem(task, period, index) { 
                return `<li class="task-item flex items-center bg-gray-50 p-2 rounded-lg shadow-sm cursor-move ${task.done ? 'opacity-50' : ''}" draggable="true" data-period="${period}" data-index="${index}">
                            <input type="checkbox" id="task-${period}-${index}" class="hidden task-checkbox" ${task.done ? 'checked' : ''} data-period="${period}" data-index="${index}">
                            <label for="task-${period}-${index}" class="flex items-center grow cursor-pointer">
                                <img src="${task.img}" alt="${task.text}" class="w-10 h-10 mr-3 object-contain flex-shrink-0">
                                <span class="grow text-gray-700 font-semibold" contenteditable="true" data-period="${period}" data-index="${index}">${task.text}</span>
                                <div class="flex-none w-8 h-8 mr-2 flex items-center justify-center">
                                    <svg class="icon-unchecked w-8 h-8 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                    <svg class="icon-checked hidden w-8 h-8 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                </div>
                            </label>
                            <button class="speak-btn text-gray-400 hover:text-blue-500 text-xl" data-text="${task.text}">🔊</button>
                            <button class="delete-btn text-gray-400 hover:text-red-500 text-xl ml-1" data-period="${period}" data-index="${index}">🗑️</button>
                        </li>`; 
            }
            function renderAvatars() { $('#avatar-selection').innerHTML = Object.keys(avatars).map((key, i) => `<div><input type="radio" id="avatar-${key}" name="avatar" value="${key}" class="hidden" ${i === 0 ? 'checked' : ''}><label for="avatar-${key}" class="cursor-pointer p-2 rounded-full border-4 border-transparent text-5xl transition-all duration-200 hover:bg-blue-100">${avatars[key].emoji}</label></div>`).join(''); }
            function renderTaskLibrary() {
                const catNames = { higiene: "Higiene", vestimenta: "Vestimenta", comidas: "Comidas", responsabilidades: "Responsabilidades", calmaYDescanso: "Calma y Descanso", juegoYAprendizaje: "Juego y Aprendizaje" };
                $('#library-content').innerHTML = Object.keys(taskLibrary).map(cat => `<div class="mb-4"><h3 class="text-lg font-bold text-left text-blue-600 p-1">${catNames[cat]}</h3><div class="flex flex-wrap">${taskLibrary[cat].map(task => `<button class="library-task-btn modern-button bg-white p-2 m-1 flex items-center text-left" data-text="${task.text}" data-img="${task.img}"><img src="${task.img}" alt="${task.text}" class="w-10 h-10 mr-2 object-contain"><span class="font-semibold">${task.text}</span></button>`).join('')}</div></div>`).join('');
            }
            function renderRewardStore() {
                const grid = $('#rewards-store-grid');
                grid.innerHTML = state.customRewards.length === 0 ? `<p class="col-span-full text-gray-500">Aún no hay recompensas. ¡Pídele a un adulto que añada algunas en Ajustes!</p>` 
                    : state.customRewards.map((r, i) => {
                        const canAfford = state.starBalance >= r.cost;
                        return `<div class="reward-item modern-card p-4 flex flex-col items-center justify-between"><span class="text-5xl mb-2">${r.icon}</span><p class="font-bold text-center">${r.text}</p><div class="flex items-center font-bold text-amber-500 my-2">${r.cost} <span class="text-2xl ml-1">🌟</span></div><button data-index="${i}" class="redeem-reward-btn modern-button w-full py-1 ${canAfford ? 'modern-button-primary' : 'bg-gray-300 cursor-not-allowed'}" ${!canAfford ? 'disabled' : ''}>Canjear</button></div>`;
                    }).join('');
            }
            function renderCustomRewardsList() {
                 $('#custom-rewards-list').innerHTML = state.customRewards.length === 0 ? `<p class="text-gray-500 text-center">No hay recompensas personalizadas.</p>`
                    : state.customRewards.map((r, i) => `<div class="flex items-center justify-between p-2 bg-white rounded-lg mb-2"><span>${r.icon} ${r.text} - <b>${r.cost}🌟</b></span><button data-index="${i}" class="delete-reward-btn text-red-500 font-bold text-2xl">&times;</button></div>`).join('');
            }
            
            // --- EVENT HANDLERS ---
            function addEventListeners() {
                // Main Page
                $$('.day-selector').forEach(b => b.addEventListener('click', e => { state.currentDay = e.target.dataset.day; renderApp(); }));
                $$('.task-checkbox').forEach(cb => cb.addEventListener('change', e => handleTaskCheck(e.target.dataset.period, e.target.dataset.index, e.target.checked)));
                $$('.add-task-btn').forEach(b => b.addEventListener('click', e => {
                    const period = e.target.dataset.period;
                    const input = $(`#new-task-${period}`);
                    if (input.value.trim()) { state.tasks[state.currentDay][period].push({ text: input.value.trim(), img: 'https://static.arasaac.org/pictograms/2750/2750_300.png', done: false, stars: 1 }); input.value = ''; saveAndRender(); }
                }));
                $$('[contenteditable="true"]').forEach(s => {
                    s.addEventListener('blur', e => { state.tasks[state.currentDay][e.target.dataset.period][e.target.dataset.index].text = e.target.innerText; saveState(); });
                    s.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); e.target.blur(); } });
                });
                $$('.delete-btn').forEach(b => b.addEventListener('click', e => { const { period, index } = e.currentTarget.dataset; state.tasks[state.currentDay][period].splice(index, 1); saveAndRender(); }));
                $$('.speak-btn').forEach(b => b.addEventListener('click', e => { const u = new SpeechSynthesisUtterance(e.currentTarget.dataset.text); u.lang = 'es-ES'; synth.speak(u); }));
                
                // Header & Modals
                $('#rewards-store-btn').addEventListener('click', () => { renderRewardStore(); modals.rewardsStore.style.display = 'flex'; });
                $('#settings-btn').addEventListener('click', () => { renderCustomRewardsList(); modals.settings.style.display = 'flex'; });
                $('#logout-btn').addEventListener('click', () => modals.logout.style.display = 'flex');
                $('#copy-day-btn').addEventListener('click', handleOpenCopyModal);
                $$('.close-modal-btn').forEach(btn => btn.addEventListener('click', (e) => e.target.closest('.fixed').style.display = 'none'));
                $('#cancel-logout-btn').addEventListener('click', () => modals.logout.style.display = 'none');
                $('#confirm-logout-btn').addEventListener('click', () => { localStorage.removeItem('miRutinaDivertida_v2'); location.reload(); });
                $('#confirm-copy-btn').addEventListener('click', handleConfirmCopy);
                $$('.open-library-btn').forEach(b => b.addEventListener('click', e => { modals.library.dataset.period = e.currentTarget.dataset.period; modals.library.style.display = 'flex'; }));
                
                // Settings Modal
                $('#add-reward-btn').addEventListener('click', () => {
                    const text = $('#reward-text').value.trim(); const icon = $('#reward-icon').value.trim(); const cost = parseInt($('#reward-cost').value);
                    if(text && icon && cost > 0) { state.customRewards.push({ text, icon, cost }); saveState(); renderCustomRewardsList(); $('#reward-text').value = $('#reward-icon').value = $('#reward-cost').value = ''; }
                });

                // Dynamic Listeners
                document.body.addEventListener('click', e => {
                    if (e.target.matches('.delete-reward-btn')) { state.customRewards.splice(e.target.dataset.index, 1); saveState(); renderCustomRewardsList(); }
                    if (e.target.matches('.redeem-reward-btn')) { const reward = state.customRewards[e.target.dataset.index]; if(state.starBalance >= reward.cost) { state.starBalance -= reward.cost; showNotification(`¡${reward.text} canjeado!`); saveState(); renderRewardStore(); } }
                    
                    const libraryBtn = e.target.closest('.library-task-btn');
                    if (libraryBtn) { 
                        const { text, img } = libraryBtn.dataset; 
                        const period = modals.library.dataset.period; 
                        state.tasks[state.currentDay][period].push({ text, img, done: false, stars: 1 }); 
                        modals.library.style.display = 'none'; 
                        saveAndRender(); 
                    }
                });
                
                addDragDropListeners();
            }

            function handleTaskCheck(period, index, isDone) {
                const task = state.tasks[state.currentDay][period][index];
                if (task.done === isDone) return;
                task.done = isDone;
                const starValue = task.stars || 1;
                state.starBalance += isDone ? starValue : -starValue;
                if (isDone) { 
                    confetti({ particleCount: 50, spread: 40, origin: { y: 0.6 } });
                }
                saveAndRender();
            }
            
            function handleOpenCopyModal() {
                $('#copy-day-name').textContent = state.currentDay;
                $('#copy-days-selection').innerHTML = daysOfWeek.filter(d => d !== state.currentDay).map(day => `<label class="flex items-center space-x-2 p-2 rounded-lg hover:bg-blue-100 cursor-pointer"><input type="checkbox" class="form-checkbox h-5 w-5 text-blue-500 rounded" value="${day}"><span class="font-semibold">${day}</span></label>`).join('');
                modals.copy.style.display = 'flex';
            }
            function handleConfirmCopy() {
                const routineToCopy = JSON.parse(JSON.stringify(state.tasks[state.currentDay]));
                $$('#copy-days-selection input:checked').forEach(cb => { state.tasks[cb.value] = JSON.parse(JSON.stringify(routineToCopy)); });
                modals.copy.style.display = 'none';
                saveAndRender();
                showNotification(`Rutina copiada!`);
            }
            
            // --- Drag & Drop ---
            function addDragDropListeners() {
                 $$('.task-item').forEach(i => { i.addEventListener('dragstart', e => { draggedTask = e.target; setTimeout(() => e.target.classList.add('dragging'), 0); }); i.addEventListener('dragend', () => draggedTask.classList.remove('dragging')); });
                 $$('.task-list').forEach(l => { l.addEventListener('dragover', e => e.preventDefault()); l.addEventListener('drop', e => { e.preventDefault(); const toPeriod = e.currentTarget.dataset.period; const targetEl = e.target.closest('.task-item'); const toIndex = targetEl ? parseInt(targetEl.dataset.index) : state.tasks[state.currentDay][toPeriod].length; const taskToMove = state.tasks[state.currentDay][draggedTask.dataset.period].splice(draggedTask.dataset.index, 1)[0]; state.tasks[state.currentDay][toPeriod].splice(toIndex, 0, taskToMove); saveAndRender(); }); });
            }
            
            function showNotification(message) {
                const el = $('#notification-modal');
                $('#notification-text').innerHTML = message;
                el.style.transform = 'translateX(0)';
                setTimeout(() => { el.style.transform = 'translateX(calc(100% + 1.25rem))'; }, 3000);
            }
            function saveAndRender() { saveState(); renderApp(); }
            function isDayComplete(day) { const tasks = state.tasks[day]; if(!tasks) return false; return [...tasks.AM, ...tasks.PM, ...tasks.Noche].every(t => t.done); }

            initialize();
        });
    </script>
</body>
</html>

