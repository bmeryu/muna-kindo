<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Rutina Divertida</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        /* Diseño 2025 */
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #F8F9FA;
            color: #212529;
        }
        .modern-card {
            background-color: #FFFFFF;
            border-radius: 1.25rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.07), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            border: 1px solid #E5E7EB;
            transition: all 0.3s ease;
        }
        .modern-button {
            border-radius: 0.75rem;
            font-weight: 700;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        }
        .modern-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .modern-button-primary { background-color: #3B82F6; color: white; }
        .modern-button-secondary { background-color: #E5E7EB; color: #374151; }

        .task-checkbox:checked + label { text-decoration: line-through; color: #9CA3AF; }
        .task-checkbox:checked + label .task-item { opacity: 0.6; }
        .task-checkbox:checked + label svg.icon-unchecked { display: none; }
        .task-checkbox:checked + label svg.icon-checked { display: inline-block; }
        .progress-bar-fill { transition: width 0.5s ease-in-out; }

        /* Modo Noche */
        .dark-mode { background-color: #111827; color: #F9FAFB; }
        .dark-mode .modern-card { background-color: #1F2937; border-color: #374151; }
        .dark-mode .modern-button-secondary { background-color: #374151; color: #F9FAFB; }
        .dark-mode .text-gray-800 { color: #F9FAFB; } .dark-mode .text-gray-500 { color: #9CA3AF; }
        .dark-mode .text-amber-500 { color: #FBBF24; }
        .dark-mode .bg-blue-100 { background-color: #1E40AF; }
        .dark-mode .bg-green-100 { background-color: #065F46; }
        .dark-mode .bg-purple-100 { background-color: #5B21B6; }
        .dark-mode .day-selector.bg-white { background-color: #374151; }
        .dark-mode .bg-gray-100, .dark-mode .bg-gray-50 { background-color: #374151; }
        .dark-mode #settings-modal input, .dark-mode #setup-modal input, .dark-mode #setup-modal select, .dark-mode input[id^="new-task-"] { background-color: #4B5563; border-color: #6B7280; color: #F9FAFB; }
        
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .reward-item, .task-item-wrapper { animation: fadeIn 0.3s ease-out; }
        .dragging { opacity: 0.9; box-shadow: inset 3px 3px 6px rgba(0,0,0,0.2), inset -3px -3px 6px rgba(255,255,255,0.2); }
        .drag-over { border-top: 2px dashed #3B82F6; }

        /* Estilo 3D para tarjetas de tarea e iconos */
        .task-item {
            background-color: #F8F9FA;
            border-radius: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 4px 4px 8px rgba(0, 0, 0, 0.08), -4px -4px 8px rgba(255, 255, 255, 0.9);
            transition: all 0.2s ease-in-out;
        }
        .task-item:hover {
            transform: scale(1.02);
            box-shadow: 6px 6px 12px rgba(0, 0, 0, 0.1), -6px -6px 12px rgba(255, 255, 255, 1);
        }
        .icon-container {
            width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;
            border-radius: 12px; font-size: 28px; background-color: #F1F5F9;
            box-shadow: inset 2px 2px 4px rgba(0,0,0,0.06), inset -2px -2px 4px rgba(255,255,255,1);
            margin-right: 12px; flex-shrink: 0;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2); /* Efecto 3D para el emoji */
        }
        .dark-mode .task-item {
            background-color: #1F2937; border-color: #374151;
            box-shadow: 4px 4px 8px #111827, -4px -4px 8px #2d3a4b;
        }
        .dark-mode .task-item:hover {
            box-shadow: 6px 6px 12px #111827, -6px -6px 12px #2d3a4b;
        }
        .dark-mode .icon-container {
            background-color: #374151;
            box-shadow: inset 2px 2px 4px #111827, inset -2px -2px 4px #4b5563;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.4); /* Sombra ajustada para modo oscuro */
        }
    </style>
</head>
<body class="transition-colors duration-500">

    <div id="app" class="max-w-5xl mx-auto p-4 md:p-6"></div>

    <!-- Modals -->
    <div id="setup-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="modern-card p-6 md:p-8 w-full max-w-md text-center">
            <h2 class="text-2xl md:text-3xl font-bold text-blue-500 mb-4">¡Bienvenido/a!</h2>
            <p class="text-gray-500 mb-6">Vamos a configurar tu rutina divertida.</p>
            <div class="mb-4 text-left">
                <label for="child-name" class="block font-bold mb-2">Nombre del niño/a:</label>
                <input type="text" id="child-name" placeholder="Ej: Leo" class="w-full p-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition-colors">
            </div>
            <div class="mb-4 text-left">
                <label class="block font-bold mb-2">Elige un avatar:</label>
                <div id="avatar-selection" class="flex justify-center flex-wrap gap-4"></div>
            </div>
            <div class="mb-6 text-left">
                <label for="routine-select" class="block font-bold mb-2">Elige una rutina base:</label>
                <select id="routine-select" class="w-full p-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none bg-white">
                    <option value="toddler">Pequeños (2-3 años)</option>
                    <option value="preschooler">Grandes (4-5 años)</option>
                </select>
            </div>
            <button id="start-button" class="modern-button modern-button-primary py-3 px-8 text-lg w-full">¡Empezar a Jugar!</button>
        </div>
    </div>
    
    <div id="rewards-store-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50 no-print">
        <div class="modern-card p-6 md:p-8 w-full max-w-2xl text-center relative max-h-[90vh] flex flex-col">
            <button class="close-modal-btn absolute top-4 right-4 text-gray-400 hover:text-gray-800 text-3xl font-bold">&times;</button>
            <h2 class="text-2xl md:text-3xl font-bold text-blue-500 mb-2">Tienda de Recompensas</h2>
            <p class="text-gray-500 mb-6">¡Usa tus estrellas para conseguir premios geniales!</p>
            <div id="rewards-store-grid" class="grid grid-cols-2 sm:grid-cols-3 gap-4 overflow-y-auto p-4 bg-gray-50 rounded-lg"></div>
        </div>
    </div>
    
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50 no-print">
         <div class="modern-card p-6 md:p-8 w-full max-w-lg text-center relative max-h-[90vh] flex flex-col">
            <button class="close-modal-btn absolute top-4 right-4 text-gray-400 hover:text-gray-800 text-3xl font-bold">&times;</button>
            <h2 class="text-2xl md:text-3xl font-bold text-blue-500 mb-4">Ajustes</h2>
            <div class="text-left overflow-y-auto">
                <h3 class="font-bold text-lg mb-2">Gestionar Recompensas de la Tienda</h3>
                <div class="bg-gray-100 p-4 rounded-lg mb-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-2 items-end">
                        <div class="flex flex-col"><label for="reward-text" class="text-sm font-bold">Nombre</label><input type="text" id="reward-text" class="p-2 rounded border" placeholder="30 min. de tablet"></div>
                        <div class="flex flex-col"><label for="reward-icon" class="text-sm font-bold">Icono</label><input type="text" id="reward-icon" class="p-2 rounded border" placeholder="📱"></div>
                        <div class="flex flex-col"><label for="reward-cost" class="text-sm font-bold">Coste (🌟)</label><input type="number" id="reward-cost" class="p-2 rounded border" placeholder="20"></div>
                    </div>
                     <button id="add-reward-btn" class="modern-button modern-button-primary w-full mt-3 py-2">Añadir Recompensa</button>
                </div>
                <div id="custom-rewards-list"></div>
            </div>
        </div>
    </div>
    
    <div id="library-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50 no-print"> <div class="modern-card p-6 md:p-8 w-full max-w-2xl relative max-h-[90vh] flex flex-col"><button class="close-modal-btn absolute top-4 right-4 text-gray-400 hover:text-gray-800 text-3xl font-bold">&times;</button><h2 class="text-2xl md:text-3xl font-bold text-blue-500 mb-4 text-center">Biblioteca de Tareas</h2><div id="library-content" class="overflow-y-auto text-left"></div></div></div>
    <div id="copy-routine-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50 no-print"><div class="modern-card p-6 md:p-8 w-full max-w-md text-center"><button class="close-modal-btn absolute top-4 right-4 text-gray-400 hover:text-gray-800 text-3xl font-bold">&times;</button><h2 class="text-xl md:text-2xl font-bold text-blue-500 mb-4">Copiar Rutina del <span id="copy-day-name"></span></h2><p class="text-gray-500 mb-6">Selecciona los días a los que quieres copiar esta rutina.</p><div id="copy-days-selection" class="grid grid-cols-2 gap-4 text-left mb-6"></div><button id="confirm-copy-btn" class="modern-button modern-button-primary py-2 px-6">Copiar</button></div></div>
    <div id="logout-confirm-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50 no-print"><div class="modern-card p-6 md:p-8 w-full max-w-sm text-center"><h2 class="text-xl md:text-2xl font-bold text-red-500 mb-4">¿Cerrar Sesión?</h2><p class="text-gray-500 mb-6">Se borrarán todos los datos. ¿Estás seguro?</p><div class="flex justify-center space-x-4"><button id="confirm-logout-btn" class="modern-button bg-red-500 text-white py-2 px-6">Sí, cerrar</button><button id="cancel-logout-btn" class="modern-button modern-button-secondary py-2 px-6">Cancelar</button></div></div></div>

    <div id="notification-modal" class="fixed top-5 right-5 bg-green-500 text-white p-4 rounded-lg shadow-lg transform translate-x-[calc(100%+1.25rem)] transition-transform duration-500 z-50 no-print"><p id="notification-text" class="font-bold"></p></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const $ = (selector) => document.querySelector(selector);
            const $$ = (selector) => document.querySelectorAll(selector);

            const modals = { setup: $('#setup-modal'), rewardsStore: $('#rewards-store-modal'), library: $('#library-modal'), logout: $('#logout-confirm-modal'), copy: $('#copy-routine-modal'), settings: $('#settings-modal'), };
            const synth = window.speechSynthesis;
            const avatars = { bunny: { name: 'Conejito', emoji: '🐰' }, bear: { name: 'Osito', emoji: '🐻' }, monster: { name: 'Monstruito', emoji: '👾' }, dino: { name: 'Dinosaurio', emoji: '🦖' }, fox: { name: 'Zorro', emoji: '🦊' }, panda: { name: 'Panda', emoji: '🐼' } };
            const daysOfWeek = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado', 'Domingo'];
            let state = {};
            let draggedTask = null;

            function generateTaskLibrary() {
                const lib = {
                    higiene: [ { text: 'Ir al baño', icon: '🚽' }, { text: 'Lavarse las manos', icon: '🧼' }, { text: 'Lavarse los dientes', icon: '🦷' }, { text: 'Peinarse', icon: '🪮' }, { text: 'Ducharse o bañarse', icon: '🛁' }, { text: 'Sonarse la nariz', icon: '🤧' }, { text: 'Cortarse las uñas', icon: '💅' } ],
                    vestimenta: [ { text: 'Vestirse', icon: '👕' }, { text: 'Ponerse el pijama', icon: '🥹' }, { text: 'Elegir la ropa', icon: '🤔' }, { text: 'Ponerse los zapatos', icon: '👟' }, { text: 'Ropa sucia al cesto', icon: '🧺' }, { text: 'Ponerse el abrigo', icon: '🧥' }, { text: 'Guardar la ropa limpia', icon: '👚' } ],
                    comidas: [ { text: 'Desayunar', icon: '🥣' }, { text: 'Comer', icon: '🥪' }, { text: 'Tomar la merienda', icon: '🍎' }, { text: 'Cenar', icon: '🍽️' }, { text: 'Poner la mesa', icon: '🍴' }, { text: 'Beber agua', icon: '💧' }, { text: 'Probar algo nuevo', icon: '🍓' }, { text: 'Ayudar a cocinar', icon: '🧑‍🍳' }, { text: 'Tomar vitaminas', icon: '💊' } ],
                    responsabilidades: [ { text: 'Ordenar los juguetes', icon: '📦' }, { text: 'Hacer la cama', icon: '🛏️' }, { text: 'Comida de la mascota', icon: '🐾' }, { text: 'Regar las plantas', icon: '🌱' }, { text: 'Sacar la basura', icon: '🗑️' }, { text: 'Ayudar con el reciclaje', icon: '♻️' }, { text: 'Limpiar mi cuarto', icon: '✨' } ],
                    calmaYDescanso: [ { text: 'Leer un cuento', icon: '📖' }, { text: 'Momento de calma', icon: '🧘' }, { text: 'Escuchar música', icon: '🎶' }, { text: 'Abrazar', icon: '🤗' }, { text: 'Ir a dormir', icon: '😴' }, { text: 'Despertar', icon: '☀️' }, { text: 'Hacer la siesta', icon: '💤' }, { text: 'Contar cómo fue mi día', icon: '🗣️' } ],
                    juegoYAprendizaje: [ { text: 'Jugar', icon: '🧸' }, { text: 'Hacer manualidades', icon: '🎨' }, { text: 'Jugar afuera', icon: '🌳' }, { text: 'Hacer los deberes', icon: '📚' }, { text: 'Practicar un deporte', icon: '⚽' }, { text: 'Andar en bicicleta', icon: '🚲' }, { text: 'Hacer un puzzle', icon: '🧩' }, { text: 'Tocar un instrumento', icon: '🎹' } ],
                    socialEmocional: [ { text: 'Decir "por favor" y "gracias"', icon: '🙏' }, { text: 'Compartir los juguetes', icon: '🤝' }, { text: 'Ayudar a un hermano/a', icon: '❤️' }, { text: 'Hablar de mis emociones', icon: '😊' }, { text: 'Pedir perdón', icon: '😔' }, { text: 'Ser amable', icon: '🥰' } ],
                    salidasYPaseos: [ { text: 'Preparar la mochila', icon: '🎒' }, { text: 'Ir al colegio/jardín', icon: '🏫' }, { text: 'Ir al parque', icon: '🏞️' }, { text: 'Visitar a los abuelos', icon: '👵' }, { text: 'Ir al doctor', icon: '🩺' } ]
                };
                Object.values(lib).forEach(category => category.forEach(task => { task.stars = 1; }));
                return lib;
            }
            const taskLibrary = generateTaskLibrary();

            const routines = {
                toddler: { AM: [ taskLibrary.calmaYDescanso[5], taskLibrary.higiene[0], taskLibrary.higiene[2], taskLibrary.vestimenta[0], taskLibrary.comidas[0] ], PM: [ taskLibrary.comidas[1], taskLibrary.juegoYAprendizaje[0], taskLibrary.responsabilidades[0], taskLibrary.comidas[2] ], Noche: [ taskLibrary.comidas[3], taskLibrary.vestimenta[1], taskLibrary.higiene[2], taskLibrary.calmaYDescanso[0], taskLibrary.calmaYDescanso[4] ] },
                preschooler: { AM: [ taskLibrary.responsabilidades[1], taskLibrary.higiene[0], taskLibrary.higiene[2], taskLibrary.vestimenta[0], taskLibrary.comidas[0] ], PM: [ taskLibrary.comidas[1], taskLibrary.juegoYAprendizaje[3], taskLibrary.responsabilidades[0] ], Noche: [ taskLibrary.comidas[3], taskLibrary.vestimenta[1], taskLibrary.higiene[2], taskLibrary.calmaYDescanso[0], taskLibrary.calmaYDescanso[4] ] }
            };

            function resetState() { state = { childName: '', avatar: 'bunny', currentDay: new Date().toLocaleDateString('es-ES', { weekday: 'long' }).replace(/^\w/, c => c.toUpperCase()), darkMode: false, tasks: {}, starBalance: 0, customRewards: [] }; }
            function saveState() { localStorage.setItem('miRutinaDivertida_v2', JSON.stringify(state)); }
            function loadState() {
                const savedState = localStorage.getItem('miRutinaDivertida_v2');
                if (savedState) {
                    state = JSON.parse(savedState);
                    if (state.customRewards === undefined) state.customRewards = [];
                    if (state.starBalance === undefined) state.starBalance = 0;

                    // --- MIGRATION LOGIC ---
                    if (state.tasks && Object.keys(state.tasks).length > 0) {
                        let wasMigrated = false;
                        const emojiMap = new Map();
                        Object.values(taskLibrary).flat().forEach(libTask => emojiMap.set(libTask.text, libTask.icon));
                        
                        Object.values(state.tasks).forEach(day => {
                            Object.values(day).forEach(periodTasks => {
                                periodTasks.forEach(task => {
                                    if (task.hasOwnProperty('img') || task.hasOwnProperty('t') || task.hasOwnProperty('i')) {
                                        wasMigrated = true;
                                        const originalText = task.text || task.t;
                                        task.text = originalText;
                                        task.icon = emojiMap.get(originalText) || '✏️';
                                        delete task.img;
                                        delete task.t;
                                        delete task.i;
                                    }
                                });
                            });
                        });
                        if (wasMigrated) saveState();
                    }
                    if(state.darkMode) document.body.classList.add('dark-mode');
                } 
                else { resetState(); }
            }
            
            function initialize() {
                loadState();
                renderAvatars();
                renderTaskLibrary();
                if (state.childName) { modals.setup.style.display = 'none'; renderApp(); }
                $('#start-button').addEventListener('click', () => {
                    state.childName = $('#child-name').value.trim();
                    if (!state.childName) return;
                    state.avatar = $('input[name="avatar"]:checked').value;
                    if(Object.keys(state.tasks).length === 0) initializeTasksForWeek();
                    modals.setup.style.display = 'none';
                    saveAndRender();
                });
                // Attach the delegated body listener only ONCE
                document.body.addEventListener('click', handleBodyClick);
            }
            function initializeTasksForWeek() {
                const selectedRoutine = routines[$('#routine-select').value];
                daysOfWeek.forEach(day => { state.tasks[day] = JSON.parse(JSON.stringify(selectedRoutine)); });
            }

            function renderApp() {
                const dayTasks = state.tasks[state.currentDay] || routines.toddler;
                const allDayTasks = [...dayTasks.AM, ...dayTasks.PM, ...dayTasks.Noche];
                const progress = allDayTasks.length > 0 ? (allDayTasks.filter(t => t.done).length / allDayTasks.length) * 100 : 0;
                
                $('#app').innerHTML = `
                    <header class="modern-card p-4 mb-6 text-center no-print">
                        <div class="flex justify-between items-center mb-4">
                            <div class="flex items-center gap-2">${Object.keys(avatars).map(key => `<div class="${state.avatar === key ? '' : 'hidden'} text-5xl">${avatars[key].emoji}</div>`).join('')} <div><p class="text-gray-500">Rutina de</p><h1 class="text-2xl font-bold text-gray-800">${state.childName}</h1></div> </div>
                            <div class="flex items-center justify-center bg-amber-100 rounded-full px-4 py-1 shadow-inner"><span class="text-2xl font-bold text-amber-600">${state.starBalance}</span><span class="text-3xl ml-1">🌟</span></div>
                            <div class="flex items-center space-x-2">
                                <button id="rewards-store-btn" class="modern-button bg-white p-3" title="Tienda de Recompensas">🎁</button>
                                <button id="settings-btn" class="modern-button bg-white p-3" title="Ajustes">⚙️</button>
                                <button id="logout-btn" class="modern-button bg-white p-3" title="Cerrar Sesión">🚪</button>
                            </div>
                        </div>
                        <div class="mb-4"><p class="text-gray-500 mb-2 font-semibold">Progreso Semanal:</p><div class="flex justify-center space-x-2">${daysOfWeek.map(day => `<div class="flex flex-col items-center"><span class="text-xs font-bold">${day.substring(0,3)}</span><span class="text-2xl">${isDayComplete(day) ? '🌟' : '⚪'}</span></div>`).join('')}</div></div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5"><div class="bg-blue-500 h-2.5 rounded-full progress-bar-fill" style="width: ${progress}%"></div></div>
                    </header>
                    <div class="flex justify-between items-center mb-6 no-print">
                        <div class="flex space-x-2 overflow-x-auto pb-2">${daysOfWeek.map(day => `<button class="day-selector modern-button text-sm sm:text-base py-2 px-4 whitespace-nowrap ${state.currentDay === day ? 'modern-button-primary' : 'bg-white'}" data-day="${day}">${day}</button>`).join('')}</div>
                        <button id="copy-day-btn" class="modern-button modern-button-secondary p-2 ml-2" title="Copiar rutina del día">📋</button>
                    </div>
                    <main class="grid md:grid-cols-3 gap-6">${renderTaskList('AM', 'Mañana', dayTasks.AM)} ${renderTaskList('PM', 'Tarde', dayTasks.PM)} ${renderTaskList('Noche', 'Noche', dayTasks.Noche)}</main>`;
                addEventListeners();
            }

            function renderTaskList(period, title, tasks) {
                const colors = { AM: 'bg-blue-100', PM: 'bg-green-100', Noche: 'bg-purple-100' };
                return `
                    <div class="modern-card p-4 flex flex-col">
                        <h2 class="text-xl font-extrabold text-center mb-4 ${colors[period]} rounded-lg py-2">${title}</h2>
                        <ul class="space-y-3 task-list flex-grow" data-period="${period}">${tasks.map((task, index) => renderTaskItem(task, period, index)).join('')}</ul>
                        <div class="mt-4">
                            <button class="open-library-btn modern-button modern-button-primary w-full mb-2 py-2" data-period="${period}">Añadir de Biblioteca</button>
                            <div class="flex space-x-2">
                                <input type="text" id="new-task-${period}" class="w-full p-2 border-2 border-gray-200 rounded-lg" placeholder="Tarea personalizada...">
                                <button class="add-task-btn modern-button modern-button-secondary px-4" data-period="${period}">Añadir</button>
                            </div>
                        </div>
                    </div>`;
            }
            function renderTaskItem(task, period, index) { 
                return `<li class="task-item-wrapper" draggable="true" data-period="${period}" data-index="${index}">
                            <input type="checkbox" id="task-${period}-${index}" class="hidden task-checkbox" ${task.done ? 'checked' : ''} data-period="${period}" data-index="${index}">
                            <label for="task-${period}-${index}" class="flex items-center grow cursor-pointer">
                                <div class="task-item flex items-center p-2 w-full">
                                    <div class="icon-container">${task.icon}</div>
                                    <span class="grow text-gray-700 font-semibold" contenteditable="true" data-period="${period}" data-index="${index}">${task.text}</span>
                                    <div class="flex-none w-8 h-8 mr-2 flex items-center justify-center">
                                        <svg class="icon-unchecked w-8 h-8 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                        <svg class="icon-checked hidden w-8 h-8 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                    </div>
                                    <button class="speak-btn text-gray-400 hover:text-blue-500 text-xl" data-text="${task.text}">🔊</button>
                                    <button class="delete-btn text-gray-400 hover:text-red-500 text-xl ml-1" data-period="${period}" data-index="${index}">🗑️</button>
                                </div>
                            </label>
                        </li>`; 
            }
            function renderAvatars() { $('#avatar-selection').innerHTML = Object.keys(avatars).map((key, i) => `<div><input type="radio" id="avatar-${key}" name="avatar" value="${key}" class="hidden" ${i === 0 ? 'checked' : ''}><label for="avatar-${key}" class="cursor-pointer p-2 rounded-full border-4 border-transparent text-5xl transition-all duration-200 hover:bg-blue-100">${avatars[key].emoji}</label></div>`).join(''); }
            function renderTaskLibrary() {
                const catNames = { higiene: "Higiene", vestimenta: "Vestimenta", comidas: "Comidas", responsabilidades: "Responsabilidades", calmaYDescanso: "Calma y Descanso", juegoYAprendizaje: "Juego y Aprendizaje", socialEmocional: "Social y Emocional", salidasYPaseos: "Salidas y Paseos" };
                $('#library-content').innerHTML = Object.keys(taskLibrary).map(cat => `<div class="mb-4"><h3 class="text-lg font-bold text-left text-blue-600 p-1">${catNames[cat]}</h3><div class="flex flex-wrap">${taskLibrary[cat].map(task => `<button class="library-task-btn modern-button bg-white p-2 m-1 flex items-center text-left" data-text="${task.text}" data-icon="${task.icon}"><div class="icon-container !mr-2">${task.icon}</div><span class="font-semibold">${task.text}</span></button>`).join('')}</div></div>`).join('');
            }
            function renderRewardStore() {
                const grid = $('#rewards-store-grid');
                grid.innerHTML = state.customRewards.length === 0 ? `<p class="col-span-full text-gray-500">Aún no hay recompensas. ¡Pídele a un adulto que añada algunas en Ajustes!</p>` 
                    : state.customRewards.map((r, i) => {
                        const canAfford = state.starBalance >= r.cost;
                        return `<div class="reward-item modern-card p-4 flex flex-col items-center justify-between"><span class="text-5xl mb-2">${r.icon}</span><p class="font-bold text-center">${r.text}</p><div class="flex items-center font-bold text-amber-500 my-2">${r.cost} <span class="text-2xl ml-1">🌟</span></div><button data-index="${i}" class="redeem-reward-btn modern-button w-full py-1 ${canAfford ? 'modern-button-primary' : 'bg-gray-300 cursor-not-allowed'}" ${!canAfford ? 'disabled' : ''}>Canjear</button></div>`;
                    }).join('');
            }
            function renderCustomRewardsList() {
                 $('#custom-rewards-list').innerHTML = state.customRewards.length === 0 ? `<p class="text-gray-500 text-center">No hay recompensas personalizadas.</p>`
                    : state.customRewards.map((r, i) => `<div class="flex items-center justify-between p-2 bg-white rounded-lg mb-2"><span>${r.icon} ${r.text} - <b>${r.cost}🌟</b></span><button data-index="${i}" class="delete-reward-btn text-red-500 font-bold text-2xl">&times;</button></div>`).join('');
            }
            
            function handleBodyClick(e) {
                if (e.target.matches('.delete-reward-btn')) { state.customRewards.splice(e.target.dataset.index, 1); saveState(); renderCustomRewardsList(); }
                if (e.target.matches('.redeem-reward-btn')) { const reward = state.customRewards[e.target.dataset.index]; if(state.starBalance >= reward.cost) { state.starBalance -= reward.cost; showNotification(`¡${reward.text} canjeado!`); saveState(); renderRewardStore(); renderApp(); } }
                const libraryBtn = e.target.closest('.library-task-btn');
                if (libraryBtn) { const { text, icon } = libraryBtn.dataset; const period = modals.library.dataset.period; state.tasks[state.currentDay][period].push({ text, icon, done: false, stars: 1 }); modals.library.style.display = 'none'; saveAndRender(); }
            }

            function addEventListeners() {
                $$('.day-selector').forEach(b => b.addEventListener('click', e => { state.currentDay = e.target.dataset.day; renderApp(); }));
                $$('.task-checkbox').forEach(cb => cb.addEventListener('change', e => handleTaskCheck(e.target.dataset.period, e.target.dataset.index, e.target.checked)));
                $$('.add-task-btn').forEach(b => b.addEventListener('click', e => { const period = e.target.dataset.period; const input = $(`#new-task-${period}`); if (input.value.trim()) { state.tasks[state.currentDay][period].push({ text: input.value.trim(), icon: '✏️', done: false, stars: 1 }); input.value = ''; saveAndRender(); } }));
                $$('[contenteditable="true"]').forEach(s => { s.addEventListener('blur', e => { state.tasks[state.currentDay][e.target.dataset.period][e.target.dataset.index].text = e.target.innerText; saveState(); }); s.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); e.target.blur(); } }); });
                $$('.delete-btn').forEach(b => b.addEventListener('click', e => { const { period, index } = e.currentTarget.dataset; state.tasks[state.currentDay][period].splice(index, 1); saveAndRender(); }));
                $$('.speak-btn').forEach(b => b.addEventListener('click', e => { const u = new SpeechSynthesisUtterance(e.currentTarget.dataset.text); u.lang = 'es-ES'; synth.speak(u); }));
                
                $('#rewards-store-btn').addEventListener('click', () => { renderRewardStore(); modals.rewardsStore.style.display = 'flex'; });
                $('#settings-btn').addEventListener('click', () => { renderCustomRewardsList(); modals.settings.style.display = 'flex'; });
                $('#logout-btn').addEventListener('click', () => modals.logout.style.display = 'flex');
                $('#copy-day-btn').addEventListener('click', () => { $('#copy-day-name').textContent = state.currentDay; $('#copy-days-selection').innerHTML = daysOfWeek.filter(d => d !== state.currentDay).map(day => `<label class="flex items-center space-x-2 p-2 rounded-lg hover:bg-blue-100 cursor-pointer"><input type="checkbox" class="form-checkbox h-5 w-5 text-blue-500 rounded" value="${day}"><span class="font-semibold">${day}</span></label>`).join(''); modals.copy.style.display = 'flex'; });
                $$('.close-modal-btn').forEach(btn => btn.addEventListener('click', (e) => e.target.closest('.fixed').style.display = 'none'));
                $('#cancel-logout-btn').addEventListener('click', () => modals.logout.style.display = 'none');
                $('#confirm-logout-btn').addEventListener('click', () => { localStorage.removeItem('miRutinaDivertida_v2'); location.reload(); });
                $('#confirm-copy-btn').addEventListener('click', () => { $$('#copy-days-selection input:checked').forEach(cb => { state.tasks[cb.value] = JSON.parse(JSON.stringify(state.tasks[state.currentDay])); }); modals.copy.style.display = 'none'; saveAndRender(); showNotification(`Rutina copiada!`); });
                $$('.open-library-btn').forEach(b => b.addEventListener('click', e => { modals.library.dataset.period = e.currentTarget.dataset.period; modals.library.style.display = 'flex'; }));
                
                $('#add-reward-btn').addEventListener('click', () => { const text = $('#reward-text').value.trim(); const icon = $('#reward-icon').value.trim(); const cost = parseInt($('#reward-cost').value); if(text && icon && cost > 0) { state.customRewards.push({ text, icon, cost }); saveState(); renderCustomRewardsList(); $('#reward-text').value = $('#reward-icon').value = $('#reward-cost').value = ''; } });

                addDragDropListeners();
            }

            function handleTaskCheck(period, index, isDone) {
                const task = state.tasks[state.currentDay][period][index];
                if (task.done === isDone) return;
                task.done = isDone;
                state.starBalance += isDone ? (task.stars || 1) : -(task.stars || 1);
                if (isDone) confetti({ particleCount: 50, spread: 40, origin: { y: 0.6 } });
                saveAndRender();
            }
            
            function addDragDropListeners() {
                 $$('.task-item-wrapper').forEach(i => { i.addEventListener('dragstart', e => { draggedTask = e.currentTarget; setTimeout(() => e.currentTarget.classList.add('dragging'), 0); }); i.addEventListener('dragend', () => draggedTask.classList.remove('dragging')); });
                 $$('.task-list').forEach(l => { l.addEventListener('dragover', e => e.preventDefault()); l.addEventListener('drop', e => { e.preventDefault(); const toPeriod = e.currentTarget.dataset.period; const targetEl = e.target.closest('.task-item-wrapper'); const toIndex = targetEl ? parseInt(targetEl.dataset.index) : state.tasks[state.currentDay][toPeriod].length; const taskToMove = state.tasks[state.currentDay][draggedTask.dataset.period].splice(draggedTask.dataset.index, 1)[0]; state.tasks[state.currentDay][toPeriod].splice(toIndex, 0, taskToMove); saveAndRender(); }); });
            }
            
            function showNotification(message) {
                const el = $('#notification-modal');
                $('#notification-text').innerHTML = message;
                el.style.transform = 'translateX(0)';
                setTimeout(() => { el.style.transform = 'translateX(calc(100% + 1.25rem))'; }, 3000);
            }
            function saveAndRender() { saveState(); renderApp(); }
            function isDayComplete(day) { const tasks = state.tasks[day]; if(!tasks) return false; return [...tasks.AM, ...tasks.PM, ...tasks.Noche].every(t => t.done); }

            initialize();
        });
    </script>
</body>
</html>

