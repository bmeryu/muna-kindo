<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rutinas Mágicas - To-Do List Infantil</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Estilos mejorados y tema "Cálido y Juguetón" */
        body {
            font-family: 'Baloo 2', cursive;
            background: linear-gradient(180deg, #FFFBF2 0%, #FFF5E1 100%);
            color: #4A3F35; /* Marrón oscuro más cálido */
            overscroll-behavior-y: contain;
        }

        /* Tema Claro (Default) */
        :root {
            --bg-primary: #F8F4E8;
            --bg-secondary: #FFFFFF;
            --text-primary: #4A3F35;
            --text-secondary: #9E8E7E;
            --accent-1: #FF8A65; /* Coral vibrante */
            --accent-2: #64B5F6; /* Azul cielo vibrante */
            --accent-3: #81C784; /* Verde menta vibrante */
            --accent-4: #FFD54F; /* Amarillo sol */
            --button-bg: #FF8A65;
            --button-text: #FFFFFF;
            --shadow-color: rgba(74, 63, 53, 0.1);
            --card-color: var(--accent-1); /* Color por defecto para la barra de la tarjeta */
        }

        /* Tema Oscuro ("Modo Noche") */
        .dark {
            --bg-primary: #37474F;
            --bg-secondary: #455A64;
            --text-primary: #ECEFF1;
            --text-secondary: #B0BEC5;
            --accent-1: #78909C;
            --accent-2: #78909C;
            --accent-3: #A5D6A7; /* Un verde más brillante para contraste */
            --accent-4: #FFE082; /* Amarillo para contraste */
            --button-bg: #546E7A;
            --button-text: #ECEFF1;
            --shadow-color: rgba(0, 0, 0, 0.2);
        }
        
        body.dark {
            background: #263238;
            color: var(--text-primary);
        }
        
        .task-card {
            background-color: var(--bg-secondary);
            border-radius: 20px;
            box-shadow: 0 10px 25px -5px var(--shadow-color);
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            position: relative;
            overflow: hidden;
            padding-top: 1.5rem; /* Espacio para la barra de color */
        }

        .task-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 10px;
            background-color: var(--card-color);
            transition: background-color 0.3s ease;
        }

        .task-card:hover {
            transform: translateY(-6px) scale(1.02);
            box-shadow: 0 20px 30px -10px var(--shadow-color);
        }

        .task-checkbox {
            width: 2.8rem;
            height: 2.8rem;
            border-radius: 50%;
            border: 3px solid var(--text-secondary);
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .task-item-wrapper.completed .task-checkbox {
            background-color: var(--accent-3);
            border-color: var(--accent-3);
            transform: scale(1.1);
        }
        
        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1.1); }
        }
        
        .task-item-wrapper.completed .task-checkbox {
            animation: pop 0.4s ease-out;
        }

        .task-item-wrapper.completed .task-checkbox i {
            opacity: 1;
            transform: scale(1) rotate(0deg);
        }
        
        .task-item-wrapper.completed .task-text {
            text-decoration: line-through;
            color: var(--text-secondary);
            text-decoration-thickness: 2px;
        }
        
        .task-checkbox i {
            color: white;
            font-size: 1.6rem;
            opacity: 0;
            transform: scale(0.3) rotate(-180deg);
            transition: all 0.3s ease-out;
        }

        .progress-bar-bg {
            background-color: rgba(0,0,0,0.05);
            border-radius: 9999px;
            overflow: hidden;
            height: 24px;
            padding: 4px;
        }

        .progress-bar-fill {
            background-image: linear-gradient(90deg, var(--accent-3), var(--accent-4));
            transition: width 0.7s cubic-bezier(0.23, 1, 0.32, 1);
            border-radius: 9999px;
        }
        
        .nav-button {
            transition: all 0.2s ease;
            color: var(--text-secondary);
        }
        .nav-button.active {
            color: var(--button-bg);
            transform: scale(1.15) translateY(-5px);
        }
        
        /* Animación de confeti */
        .confetti-piece {
            position: absolute;
            width: 8px;
            height: 16px;
            opacity: 0;
        }
        
        /* Modal más suave */
        .modal-content {
            background-color: var(--bg-secondary);
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        
        .day-selector-btn, .avatar-selector, button {
             transition: transform 0.1s ease;
        }
        .day-selector-btn:active, .avatar-selector:active, button:active {
            transform: scale(0.95);
        }
        
        .icon-selector-btn.selected {
            background-color: var(--accent-2);
            color: white;
            border-color: var(--accent-2);
        }

        /* Estilos para arrastrar y soltar */
        .drag-handle {
            cursor: grab;
        }
        .sortable-ghost {
            opacity: 0.4;
            background: #c8ebfb;
            border-radius: 10px;
        }
        .sortable-chosen {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }


        /* Estilo para impresión */
        @media print {
            body, body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none; }
        }
    </style>
</head>
<body class="transition-colors duration-300">

    <div id="app-container" class="max-w-md mx-auto min-h-screen flex flex-col pt-4 pb-24 relative overflow-x-hidden">

        <!-- Encabezado con perfil del niño -->
        <header class="flex items-center justify-between px-4 pb-4 mb-4 border-b-2 border-[#F0EAD6]">
            <div class="flex items-center gap-4">
                <div id="avatar-display" class="w-16 h-16 text-5xl flex items-center justify-center rounded-full bg-white shadow-lg">🐰</div>
                <h1 class="text-3xl font-bold text-[var(--text-primary)]">Hola, <span id="child-name-display" class="text-[var(--button-bg)]">Peque</span>!</h1>
            </div>
            <button onclick="showView('settings')" class="text-3xl text-gray-400 hover:text-[var(--button-bg)] transition-colors">
                <i class="fas fa-cog fa-spin-hover"></i>
            </button>
        </header>

        <!-- Contenido principal (vistas intercambiables) -->
        <main class="flex-grow px-4">
            <!-- Vista de Tareas (Home) -->
            <div id="tasks-view">
                <!-- Barra de Progreso -->
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-md font-semibold">Tu progreso de hoy</span>
                        <span id="progress-text" class="text-md font-bold text-[var(--accent-3)]">0%</span>
                    </div>
                    <div class="progress-bar-bg">
                        <div id="progress-bar" class="progress-bar-fill h-full" style="width: 0%;"></div>
                    </div>
                </div>

                <!-- Selector de Día -->
                <div class="flex justify-around items-center mb-6 p-2 bg-white/50 rounded-full no-print shadow-inner">
                    <button onclick="changeDay(this, 'Lunes')" class="day-selector-btn active bg-[var(--button-bg)] text-[var(--button-text)] w-10 h-10 rounded-full font-bold text-lg shadow">L</button>
                    <button onclick="changeDay(this, 'Martes')" class="day-selector-btn text-[var(--text-secondary)] w-10 h-10 rounded-full font-bold text-lg">M</button>
                    <button onclick="changeDay(this, 'Miércoles')" class="day-selector-btn text-[var(--text-secondary)] w-10 h-10 rounded-full font-bold text-lg">X</button>
                    <button onclick="changeDay(this, 'Jueves')" class="day-selector-btn text-[var(--text-secondary)] w-10 h-10 rounded-full font-bold text-lg">J</button>
                    <button onclick="changeDay(this, 'Viernes')" class="day-selector-btn text-[var(--text-secondary)] w-10 h-10 rounded-full font-bold text-lg">V</button>
                    <button onclick="changeDay(this, 'Sábado')" class="day-selector-btn text-[var(--text-secondary)] w-10 h-10 rounded-full font-bold text-lg">S</button>
                    <button onclick="changeDay(this, 'Domingo')" class="day-selector-btn text-[var(--text-secondary)] w-10 h-10 rounded-full font-bold text-lg">D</button>
                </div>
                
                <div id="print-area">
                    <h2 id="current-day-title" class="text-4xl font-bold text-center mb-6 text-[var(--text-primary)]">Lunes</h2>
                    <div id="task-list-container" class="space-y-6">
                        <!-- Las listas de tareas se renderizarán aquí -->
                    </div>
                </div>
            </div>

            <!-- Vista de Recompensas -->
            <div id="rewards-view" class="hidden">
                 <h2 class="text-4xl font-bold text-center mb-6 text-[var(--text-primary)]">Tus Recompensas</h2>
                <div class="task-card p-4">
                    <h3 class="text-2xl font-bold mb-4 text-[var(--accent-4)]">Stickers Ganados</h3>
                    <div id="stickers-gallery" class="grid grid-cols-3 sm:grid-cols-4 gap-4 p-4 min-h-[150px]">
                        <!-- Los stickers se renderizarán aquí -->
                    </div>
                     <p id="no-stickers-msg" class="text-center text-[var(--text-secondary)]">¡Completa tareas para ganar stickers!</p>
                </div>
            </div>

            <!-- Vista de Biblioteca de Tareas -->
            <div id="library-view" class="hidden">
                <h2 class="text-4xl font-bold text-center mb-6 text-[var(--text-primary)]">Biblioteca de Tareas</h2>
                
                <div class="task-card p-4 mb-6">
                    <h3 class="text-2xl font-bold mb-4">Crear una Tarea Nueva</h3>
                    <div class="mt-2 space-y-4">
                        <input id="new-task-text-input" class="w-full p-3 rounded-lg border-2 border-gray-200 focus:border-[var(--button-bg)] outline-none bg-[var(--bg-primary)] text-lg" placeholder="Nombre de la tarea...">
                        <div>
                            <label class="font-semibold mb-2 block">Elige un ícono:</label>
                            <div id="icon-selector-container" class="grid grid-cols-6 gap-2 text-2xl">
                                <!-- Iconos para seleccionar se renderizarán aquí -->
                            </div>
                        </div>
                        <button onclick="saveNewTaskTemplate()" class="w-full bg-[var(--button-bg)] text-[var(--button-text)] font-bold py-3 rounded-xl shadow-lg hover:opacity-90 transition">
                            <i class="fas fa-plus-circle mr-2"></i>Guardar Tarea
                        </button>
                    </div>
                </div>

                <div id="custom-task-section">
                    <h3 class="text-2xl font-bold mb-4">Tus Tareas Guardadas</h3>
                    <div id="custom-task-list" class="grid grid-cols-2 sm:grid-cols-3 gap-4">
                        <!-- Tareas personalizadas aquí -->
                    </div>
                    <p id="no-custom-tasks-msg" class="text-center text-[var(--text-secondary)] hidden">Aún no has creado tareas.</p>
                </div>

                <h3 class="text-2xl font-bold mb-4 mt-6">Tareas Sugeridas</h3>
                <div id="default-task-list" class="grid grid-cols-2 sm:grid-cols-3 gap-4">
                    <!-- Tareas por defecto aquí -->
                </div>
            </div>

            <!-- Vista de Configuración -->
            <div id="settings-view" class="hidden">
                <h2 class="text-4xl font-bold text-center mb-6 text-[var(--text-primary)]">Configuración</h2>
                <div class="space-y-6">
                    <!-- Perfil del Niño -->
                    <div class="task-card p-4">
                        <h3 class="text-2xl font-bold mb-4">Perfil del Niño/a</h3>
                        <label class="block mb-2 font-semibold">Nombre:</label>
                        <input id="child-name-input" type="text" class="w-full p-3 rounded-lg border-2 border-gray-200 focus:border-[var(--button-bg)] outline-none bg-[var(--bg-primary)] text-lg" placeholder="Nombre de tu peque">
                        
                        <label class="block mt-4 mb-2 font-semibold">Elige un Avatar:</label>
                        <div class="grid grid-cols-4 gap-4 text-4xl">
                            <button onclick="selectAvatar(this, '🐰')" class="avatar-selector p-2 rounded-full bg-orange-200 border-2 border-orange-400">🐰</button>
                            <button onclick="selectAvatar(this, '🐻')" class="avatar-selector p-2 rounded-full">🐻</button>
                            <button onclick="selectAvatar(this, '🦊')" class="avatar-selector p-2 rounded-full">🦊</button>
                            <button onclick="selectAvatar(this, '🐼')" class="avatar-selector p-2 rounded-full">🐼</button>
                            <button onclick="selectAvatar(this, '🐸')" class="avatar-selector p-2 rounded-full">🐸</button>
                            <button onclick="selectAvatar(this, '🐵')" class="avatar-selector p-2 rounded-full">🐵</button>
                             <button onclick="selectAvatar(this, '🦄')" class="avatar-selector p-2 rounded-full">🦄</button>
                             <button onclick="selectAvatar(this, '🤖')" class="avatar-selector p-2 rounded-full">🤖</button>
                        </div>
                    </div>

                    <!-- Ajustes Generales -->
                    <div class="task-card p-4">
                        <h3 class="text-2xl font-bold mb-4">Ajustes Generales</h3>
                        <div class="flex items-center justify-between">
                            <span class="font-semibold">Modo Noche</span>
                            <button onclick="toggleNightMode(this)" class="w-14 h-8 flex items-center bg-gray-300 rounded-full p-1 duration-300 ease-in-out">
                                <div class="bg-white w-6 h-6 rounded-full shadow-md transform duration-300 ease-in-out"></div>
                            </button>
                        </div>
                        <div class="flex items-center justify-between mt-4">
                            <span class="font-semibold">Sonidos de recompensa</span>
                             <button onclick="toggleSound(this)" class="w-14 h-8 flex items-center bg-[var(--accent-3)] rounded-full p-1 duration-300 ease-in-out">
                                <div class="bg-white w-6 h-6 rounded-full shadow-md transform duration-300 ease-in-out translate-x-6"></div>
                            </button>
                        </div>
                    </div>
                     <!-- Exportar -->
                    <div class="task-card p-4">
                        <h3 class="text-2xl font-bold mb-4">Opciones de Rutina</h3>
                        <button onclick="printRoutine()" class="w-full bg-[var(--button-bg)] text-[var(--button-text)] font-bold py-3 rounded-xl shadow-lg hover:opacity-90 transition">
                            <i class="fas fa-print mr-2"></i>Imprimir Rutina del Día
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <!-- Navegación Inferior -->
        <nav class="fixed bottom-0 left-0 right-0 max-w-md mx-auto h-20 bg-[var(--bg-secondary)] shadow-[0_-5px_20px_var(--shadow-color)] rounded-t-3xl flex justify-around items-center no-print">
            <button onclick="showView('tasks')" class="nav-button active" data-view="tasks">
                <i class="fas fa-home text-3xl"></i>
                <span class="text-xs block font-semibold">Hoy</span>
            </button>
            <button onclick="showView('library')" class="nav-button" data-view="library">
                <i class="fas fa-book-open-reader text-3xl"></i>
                <span class="text-xs block font-semibold">Biblioteca</span>
            </button>
            <button onclick="showView('rewards')" class="nav-button" data-view="rewards">
                <i class="fas fa-star text-3xl"></i>
                <span class="text-xs block font-semibold">Premios</span>
            </button>
            <button onclick="showView('settings')" class="nav-button" data-view="settings">
                <i class="fas fa-user-cog text-3xl"></i>
                <span class="text-xs block font-semibold">Ajustes</span>
            </button>
        </nav>
        
        <!-- Modal para editar/añadir tarea -->
        <div id="task-modal" class="fixed inset-0 flex items-center justify-center modal-backdrop hidden z-50">
            <div class="modal-content w-11/12 max-w-sm p-6 rounded-2xl shadow-xl transform scale-95 opacity-0">
                 <h3 id="modal-title" class="text-2xl font-bold mb-4">Añadir Tarea</h3>
                 <div id="modal-quick-add">
                     <input id="task-text-input" type="text" class="w-full p-3 rounded-lg border-2 border-gray-200 focus:border-[var(--button-bg)] outline-none bg-[var(--bg-primary)] mb-4 text-lg" placeholder="Escribe la tarea...">
                 </div>
                 <h4 class="text-lg font-semibold mb-2 text-center text-[var(--text-secondary)]">O elige de la biblioteca</h4>
                 <div id="modal-library-list" class="max-h-40 overflow-y-auto grid grid-cols-3 gap-2 p-2 bg-[var(--bg-primary)] rounded-lg">
                    <!-- Tareas de la biblioteca para añadir -->
                 </div>
                 <div class="flex justify-end space-x-2 mt-4">
                     <button onclick="closeTaskModal()" class="px-4 py-2 rounded-lg text-[var(--text-secondary)] font-semibold">Cancelar</button>
                     <button onclick="saveTask()" class="px-5 py-2 rounded-lg bg-[var(--button-bg)] text-[var(--button-text)] font-bold">Guardar</button>
                 </div>
            </div>
        </div>
    </div>

    <script>
        // --- ESTADO DE LA APLICACIÓN ---
        const appState = {
            currentView: 'tasks',
            currentDay: 'Lunes',
            isNightMode: false,
            soundEnabled: true,
            profile: { name: 'Peque', avatar: '🐰' },
            tasks: {},
            rewards: {
                stickers: ['🌟', '💖', '🚀', '🌈', '✅', '👑', '💡', '🏆', '⚽', '🎨', '🎵', '🦕'],
                collected: []
            },
            modalContext: { isEditing: false, timeOfDay: null, taskIndex: null },
            customTaskTemplates: [],
        };
        
        // --- DATOS CONSTANTES ---
        const defaultTaskTemplates = [
            { text: 'Lavarse los dientes', icon: 'fas fa-tooth' }, { text: 'Vestirse', icon: 'fas fa-tshirt' },
            { text: 'Desayunar', icon: 'fas fa-utensils' }, { text: 'Hacer la cama', icon: 'fas fa-bed' },
            { text: 'Hacer los deberes', icon: 'fas fa-book' }, { text: 'Ordenar juguetes', icon: 'fas fa-puzzle-piece' },
            { text: 'Merienda', icon: 'fas fa-apple-alt' }, { text: 'Ponerse el pijama', icon: 'fas fa-moon' },
            { text: 'Cenar', icon: 'fas fa-concierge-bell' }, { text: 'Leer un cuento', icon: 'fas fa-book-open' },
            { text: 'Pasear al perro', icon: 'fas fa-dog' }, { text: 'Regar las plantas', icon: 'fas fa-seedling' }
        ];

        const availableIcons = [
            'fas fa-star', 'fas fa-heart', 'fas fa-car', 'fas fa-bicycle', 'fas fa-bath', 'fas fa-gamepad',
            'fas fa-music', 'fas fa-paint-brush', 'fas fa-laptop-code', 'fas fa-umbrella-beach', 'fas fa-tree', 'fas fa-cloud-sun'
        ];

        // --- SONIDOS ---
        const completeSound = new Audio('data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU'+Array(1e3).join('123'));

        // --- DATOS VISUALES ---
        const timeOfDayColors = {
            'AM ☀️': 'var(--accent-4)', // Yellow
            'PM 🎨': 'var(--accent-2)', // Blue
            'Noche 🌙': 'var(--accent-1)' // Coral
        };
        
        // --- INICIALIZACIÓN Y DATOS POR DEFECTO ---
        function initializeDefaultTasks() {
            const days = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado', 'Domingo'];
            const defaultStructure = {
                'AM ☀️': defaultTaskTemplates.slice(0, 4).map(t => ({...t, completed: false })),
                'PM 🎨': defaultTaskTemplates.slice(4, 7).map(t => ({...t, completed: false })),
                'Noche 🌙': defaultTaskTemplates.slice(7, 11).map(t => ({...t, completed: false })),
            };
            days.forEach(day => {
                appState.tasks[day] = JSON.parse(JSON.stringify(defaultStructure));
            });
        }
        
        // --- FUNCIONES DE RENDERIZADO ---
        function renderAll() {
            renderTasks();
            renderProfile();
            renderRewards();
            renderLibrary();
            updateProgressBar();
        }

        function renderTasks() {
            const container = document.getElementById('task-list-container');
            const dayTasks = appState.tasks[appState.currentDay];
            container.innerHTML = '';

            if (!dayTasks) {
                container.innerHTML = '<p class="text-center text-[var(--text-secondary)]">No hay tareas para este día.</p>';
                return;
            }

            for (const timeOfDay in dayTasks) {
                const tasks = dayTasks[timeOfDay];
                const section = document.createElement('div');
                section.className = 'task-card p-4';
                const color = timeOfDayColors[timeOfDay] || 'var(--text-secondary)';
                section.style.setProperty('--card-color', color);

                let taskItemsHTML = tasks.map((task, index) => `
                    <div class="task-item-wrapper flex items-center justify-between py-3 ${task.completed ? 'completed' : ''}">
                        <div class="flex items-center gap-4 flex-grow">
                             <div class="drag-handle text-[var(--text-secondary)] text-lg"><i class="fas fa-grip-vertical"></i></div>
                            <div class="task-checkbox" onclick="toggleTaskCompletion(this.closest('.task-item-wrapper'), '${timeOfDay}', ${index})">
                                <i class="fas fa-check"></i>
                            </div>
                            <div class="flex items-center gap-3">
                                <i class="${task.icon} text-2xl w-8 text-center" style="color:${color}"></i>
                                <span class="task-text text-xl font-medium">${task.text}</span>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 no-print">
                            <button onclick="openTaskModal(true, '${timeOfDay}', ${index})" class="text-[var(--text-secondary)] hover:text-[var(--accent-4)] text-lg"><i class="fas fa-pencil-alt"></i></button>
                            <button onclick="deleteTask('${timeOfDay}', ${index})" class="text-[var(--text-secondary)] hover:text-[var(--accent-1)] text-lg"><i class="fas fa-trash-alt"></i></button>
                             <button onclick="speakTask('${task.text}')" class="text-[var(--text-secondary)] hover:text-[var(--accent-2)] text-lg"><i class="fas fa-volume-up"></i></button>
                        </div>
                    </div>
                `).join('');

                section.innerHTML = `
                    <div class="flex justify-between items-center mb-2 px-2">
                        <h3 class="text-2xl font-bold">${timeOfDay}</h3>
                        <button onclick="openTaskModal(false, '${timeOfDay}')" class="no-print bg-[var(--button-bg)] text-white w-10 h-10 rounded-full text-2xl font-bold shadow-md hover:opacity-90 transition">+</button>
                    </div>
                    <div class="task-list" data-timeofday="${timeOfDay}">
                        ${taskItemsHTML}
                    </div>
                `;
                container.appendChild(section);
            }
            initializeDragAndDrop();
        }
        
        function renderProfile() {
            document.getElementById('child-name-display').textContent = appState.profile.name;
            document.getElementById('avatar-display').textContent = appState.profile.avatar;
            document.getElementById('child-name-input').value = appState.profile.name;
        }

        function renderRewards() {
            const gallery = document.getElementById('stickers-gallery');
            const noStickersMsg = document.getElementById('no-stickers-msg');
            gallery.innerHTML = '';
            noStickersMsg.classList.toggle('hidden', appState.rewards.collected.length > 0);

            appState.rewards.collected.forEach(sticker => {
                const stickerEl = document.createElement('div');
                stickerEl.className = 'text-6xl text-center transform hover:scale-125 transition-transform cursor-pointer';
                stickerEl.textContent = sticker;
                gallery.appendChild(stickerEl);
            });
        }
        
        function renderLibrary() {
            const defaultList = document.getElementById('default-task-list');
            const customList = document.getElementById('custom-task-list');
            const iconContainer = document.getElementById('icon-selector-container');
            const noCustomMsg = document.getElementById('no-custom-tasks-msg');

            defaultList.innerHTML = '';
            defaultTaskTemplates.forEach(task => {
                defaultList.innerHTML += createTaskTemplateCard(task);
            });
            
            customList.innerHTML = '';
            appState.customTaskTemplates.forEach((task, index) => {
                customList.innerHTML += createTaskTemplateCard(task, true, index);
            });

            noCustomMsg.classList.toggle('hidden', appState.customTaskTemplates.length > 0);

            iconContainer.innerHTML = '';
            availableIcons.forEach((icon, index) => {
                const isSelected = index === 0 ? 'selected' : '';
                iconContainer.innerHTML += `
                    <button class="icon-selector-btn border-2 rounded-lg p-2 ${isSelected}" data-icon="${icon}" onclick="selectIcon(this, '${icon}')">
                        <i class="${icon}"></i>
                    </button>
                `;
            });
        }

        function createTaskTemplateCard(task, isCustom = false, index = null) {
            let deleteButton = '';
            if (isCustom) {
                deleteButton = `<button onclick="deleteTaskTemplate(${index})" class="absolute top-1 right-1 text-red-300 hover:text-red-500"><i class="fas fa-times-circle"></i></button>`;
            }
            return `
                <div class="relative flex flex-col items-center justify-center text-center p-3 bg-[var(--bg-primary)] rounded-2xl shadow-sm">
                    <i class="${task.icon} text-3xl text-[var(--accent-1)]"></i>
                    <span class="mt-2 font-semibold text-sm">${task.text}</span>
                    ${deleteButton}
                </div>
            `;
        }

        function updateProgressBar() {
            const dayTasks = appState.tasks[appState.currentDay];
            if (!dayTasks) return;
            
            let totalTasks = 0, completedTasks = 0;
            for (const timeOfDay in dayTasks) {
                totalTasks += dayTasks[timeOfDay].length;
                completedTasks += dayTasks[timeOfDay].filter(t => t.completed).length;
            }
            
            const percentage = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            document.getElementById('progress-bar').style.width = `${percentage}%`;
            document.getElementById('progress-text').textContent = `${percentage}%`;

            if (percentage === 100 && totalTasks > 0) {
                giveReward();
            }
        }
        
        // --- LÓGICA DE INTERACCIÓN ---
        function showView(viewId) {
            ['tasks-view', 'rewards-view', 'settings-view', 'library-view'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(viewId).classList.remove('hidden');
            
            document.querySelectorAll('.nav-button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === viewId);
            });
            appState.currentView = viewId;
        }

        function changeDay(btn, day) {
            appState.currentDay = day;
            document.getElementById('current-day-title').textContent = day;
            document.querySelectorAll('.day-selector-btn').forEach(b => {
                b.classList.remove('active', 'bg-[var(--button-bg)]', 'text-[var(--button-text)]', 'shadow');
                b.classList.add('text-[var(--text-secondary)]');
            });
            btn.classList.add('active', 'bg-[var(--button-bg)]', 'text-[var(--button-text)]', 'shadow');
            btn.classList.remove('text-[var(--text-secondary)]');
            renderTasks();
            updateProgressBar();
        }

        function toggleTaskCompletion(taskElement, timeOfDay, index) {
            const task = appState.tasks[appState.currentDay][timeOfDay][index];
            task.completed = !task.completed;
            
            if (task.completed) {
                taskElement.classList.add('completed');
                playCompletionSound();
                showConfetti(taskElement.querySelector('.task-checkbox'));
            } else {
                taskElement.classList.remove('completed');
            }
            
            updateProgressBar();
            saveState();
        }

        function playCompletionSound() {
            if (appState.soundEnabled) {
                completeSound.currentTime = 0;
                completeSound.play().catch(e => console.log("Error al reproducir sonido:", e));
            }
        }

        function showConfetti(targetElement) {
            for (let i = 0; i < 30; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti-piece';
                document.body.appendChild(confetti);
                const rect = targetElement.getBoundingClientRect();
                const startX = rect.left + rect.width / 2;
                const startY = rect.top + rect.height / 2;
                
                const colors = ['var(--accent-1)', 'var(--accent-2)', 'var(--accent-3)', 'var(--accent-4)'];
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                
                confetti.style.left = `${startX}px`;
                confetti.style.top = `${startY}px`;
                
                const angle = Math.random() * 360;
                const distance = Math.random() * 80 + 50;
                const translateX = Math.cos(angle * Math.PI / 180) * distance;
                const translateY = Math.sin(angle * Math.PI / 180) * distance;
                const rotation = Math.random() * 720 - 360;

                confetti.animate([
                    { transform: 'translate(0, 0) rotate(0)', opacity: 1 },
                    { transform: `translate(${translateX}px, ${translateY}px) rotate(${rotation}deg)`, opacity: 0 }
                ], {
                    duration: 800 + Math.random() * 500,
                    easing: 'cubic-bezier(0.1, 0.9, 0.2, 1)'
                }).onfinish = () => confetti.remove();
            }
        }
        
        function giveReward() {
            const dayKey = `reward_${appState.currentDay}`;
            if(localStorage.getItem(dayKey)) return;

            const availableStickers = appState.rewards.stickers.filter(s => !appState.rewards.collected.includes(s));
            if (availableStickers.length > 0) {
                const newSticker = availableStickers[Math.floor(Math.random() * availableStickers.length)];
                appState.rewards.collected.push(newSticker);
                renderRewards();
                localStorage.setItem(dayKey, 'true');
                saveState();
                
                const stickerNotif = document.createElement('div');
                stickerNotif.className = 'fixed inset-0 bg-black/50 flex flex-col items-center justify-center z-50 text-center p-4';
                stickerNotif.innerHTML = `
                    <div class="text-8xl transform scale-50 opacity-0 animate-pop-in">${newSticker}</div>
                    <p class="text-white text-3xl font-bold mt-4 opacity-0 animate-fade-in">¡Ganaste un sticker nuevo!</p>
                `;
                document.body.appendChild(stickerNotif);
                
                stickerNotif.addEventListener('click', () => {
                     stickerNotif.classList.add('opacity-0');
                     stickerNotif.addEventListener('transitionend', () => stickerNotif.remove());
                });

                const styleSheet = document.createElement("style");
                styleSheet.type = "text/css";
                styleSheet.innerText = `
                    @keyframes pop-in { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
                    .animate-pop-in { animation: pop-in 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards; }
                    @keyframes fade-in { 0% { opacity: 0; transform: translateY(20px); } 100% { opacity: 1; transform: translateY(0); } }
                    .animate-fade-in { animation: fade-in 0.5s ease-out 0.3s forwards; }
                `;
                document.head.appendChild(styleSheet);
            }
        }

        // --- FUNCIONES DE AJUSTES Y BIBLIOTECA---
        document.getElementById('child-name-input').addEventListener('change', (e) => {
            appState.profile.name = e.target.value || 'Peque';
            renderProfile();
            saveState();
        });

        function selectAvatar(btn, avatar) {
            appState.profile.avatar = avatar;
            renderProfile();
            document.querySelectorAll('.avatar-selector').forEach(b => b.classList.remove('bg-orange-200', 'border-orange-400', 'border-2'));
            btn.classList.add('bg-orange-200', 'border-orange-400', 'border-2');
            saveState();
        }

        function toggleNightMode(btn) {
            appState.isNightMode = !appState.isNightMode;
            document.body.classList.toggle('dark', appState.isNightMode);
            const toggle = btn.querySelector('div');
            toggle.classList.toggle('translate-x-6', appState.isNightMode);
            btn.classList.toggle('bg-[var(--accent-2)]', appState.isNightMode);
            btn.classList.toggle('bg-gray-300', !appState.isNightMode);
            saveState();
        }
        
        function toggleSound(btn) {
            appState.soundEnabled = !appState.soundEnabled;
            const toggle = btn.querySelector('div');
            toggle.classList.toggle('translate-x-6', appState.soundEnabled);
            btn.classList.toggle('bg-[var(--accent-3)]', appState.soundEnabled);
            btn.classList.toggle('bg-gray-300', !appState.soundEnabled);
            saveState();
        }

        function selectIcon(btn, icon) {
             document.querySelectorAll('.icon-selector-btn').forEach(b => b.classList.remove('selected'));
             btn.classList.add('selected');
        }

        function saveNewTaskTemplate() {
            const textInput = document.getElementById('new-task-text-input');
            const text = textInput.value.trim();
            const selectedIconEl = document.querySelector('.icon-selector-btn.selected');
            if (!text || !selectedIconEl) {
                // Podríamos mostrar un mensaje de error aquí
                return;
            }
            const icon = selectedIconEl.dataset.icon;
            appState.customTaskTemplates.push({ text, icon });
            
            textInput.value = ''; // Limpiar input
            renderLibrary();
            saveState();
        }

        function deleteTaskTemplate(index) {
            appState.customTaskTemplates.splice(index, 1);
            renderLibrary();
            saveState();
        }

        function initializeDragAndDrop() {
            const lists = document.querySelectorAll('.task-list');
            lists.forEach(list => {
                new Sortable(list, {
                    handle: '.drag-handle',
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    chosenClass: 'sortable-chosen',
                    onEnd: (evt) => {
                        const timeOfDay = evt.from.dataset.timeofday;
                        const tasks = appState.tasks[appState.currentDay][timeOfDay];
                        
                        const [movedItem] = tasks.splice(evt.oldIndex, 1);
                        tasks.splice(evt.newIndex, 0, movedItem);
                        
                        saveState();
                        renderTasks(); 
                    }
                });
            });
        }
        
        // --- MODAL DE TAREAS ---
        function openTaskModal(isEditing, timeOfDay, taskIndex = null) {
            const modal = document.getElementById('task-modal');
            const modalContent = modal.querySelector('.modal-content');
            const title = document.getElementById('modal-title');
            const input = document.getElementById('task-text-input');
            const libraryList = document.getElementById('modal-library-list');
            const quickAddContainer = document.getElementById('modal-quick-add');


            appState.modalContext = { isEditing, timeOfDay, taskIndex };

            if (isEditing) {
                title.textContent = 'Editar Tarea';
                input.value = appState.tasks[appState.currentDay][timeOfDay][taskIndex].text;
                quickAddContainer.classList.remove('hidden');
                libraryList.previousElementSibling.classList.add('hidden');
                libraryList.classList.add('hidden');
            } else {
                title.textContent = `Añadir Tarea`;
                input.value = '';
                quickAddContainer.classList.remove('hidden');
                libraryList.previousElementSibling.classList.remove('hidden');
                libraryList.classList.remove('hidden');

                // Poblar modal con tareas de la biblioteca
                libraryList.innerHTML = '';
                const allTemplates = [...defaultTaskTemplates, ...appState.customTaskTemplates];
                allTemplates.forEach(template => {
                    const card = createTaskTemplateCard(template);
                    const wrapper = document.createElement('div');
                    wrapper.innerHTML = card;
                    wrapper.firstElementChild.addEventListener('click', () => {
                        addTaskFromTemplate(timeOfDay, template);
                        closeTaskModal();
                    });
                    libraryList.appendChild(wrapper);
                });
            }
            
            modal.classList.remove('hidden');
            setTimeout(() => modalContent.classList.remove('scale-95', 'opacity-0'), 10);
            input.focus();
        }

        function closeTaskModal() {
            const modalContent = document.querySelector('#task-modal .modal-content');
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => document.getElementById('task-modal').classList.add('hidden'), 300);
        }
        
        function saveTask() {
            const { isEditing, timeOfDay, taskIndex } = appState.modalContext;
            const text = document.getElementById('task-text-input').value.trim();
            if (!text) return; // Solo guardar si hay texto en el input

            if (isEditing) {
                appState.tasks[appState.currentDay][timeOfDay][taskIndex].text = text;
            } else {
                // Añadir como tarea rápida con icono por defecto
                appState.tasks[appState.currentDay][timeOfDay].push({
                    text: text, icon: 'fas fa-star', completed: false
                });
            }
            renderTasks();
            updateProgressBar();
            saveState();
            closeTaskModal();
        }

        function addTaskFromTemplate(timeOfDay, template) {
            appState.tasks[appState.currentDay][timeOfDay].push({
                ...template,
                completed: false
            });
            renderTasks();
            updateProgressBar();
            saveState();
        }

        function deleteTask(timeOfDay, index) {
            appState.tasks[appState.currentDay][timeOfDay].splice(index, 1);
            renderTasks();
            updateProgressBar();
            saveState();
        }

        // --- FUNCIONES EXTRA ---
        function speakTask(text) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'es-ES';
                window.speechSynthesis.speak(utterance);
            } else {
                console.error('SpeechSynthesis no soportado');
            }
        }
        
        function printRoutine() { window.print(); }
        
        // --- PERSISTENCIA DE DATOS ---
        function saveState() {
            localStorage.setItem('rutinasMagicasState', JSON.stringify(appState));
        }

        function loadState() {
            const savedState = localStorage.getItem('rutinasMagicasState');
            if (savedState) {
                const parsedState = JSON.parse(savedState);
                Object.assign(appState, parsedState);
            } else {
                initializeDefaultTasks();
            }
        }

        // --- ARRANQUE ---
        document.addEventListener('DOMContentLoaded', () => {
            loadState();
            if (appState.isNightMode) document.body.classList.add('dark');
            const today = new Date().toLocaleString('es-ES', { weekday: 'long' });
            const capitalizedToday = today.charAt(0).toUpperCase() + today.slice(1);
            const dayButton = Array.from(document.querySelectorAll('.day-selector-btn')).find(b => appState.tasks.hasOwnProperty(capitalizedToday) && b.getAttribute('onclick').includes(capitalizedToday));
            if (dayButton) {
                changeDay(dayButton, capitalizedToday);
            }
            renderAll();
        });
    </script>
</body>
</html>

