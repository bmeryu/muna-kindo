<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rutina de Estrellas ZEN ‚ú®</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Fredoka', sans-serif;
            background-color: #f4f7f6;
            background-image: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            overflow-x: hidden;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 8px 32px 0 rgba(100, 116, 139, 0.1);
            transition: all 0.3s ease;
        }
        .task-card { 
            background-color: white;
            border-radius: 1.25rem; /* rounded-2xl */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid #e2e8f0;
        }
        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }
        .task-card.completed { 
            background-color: #f0fdf4; /* green-50 */
            border-color: #bbf7d0; /* green-200 */
            opacity: 0.8;
        }
        .task-card.completed .task-text { 
            text-decoration: line-through;
            color: #475569; /* slate-600 */
        }
        .modal-backdrop { display: none; position: fixed; z-index: 50; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(5px); justify-content: center; align-items: center; animation: fadeIn 0.3s ease; }
        .modal-content { max-height: 90vh; overflow-y: auto; }
        .progress-bar-container { width: 100%; background-color: rgba(0, 0, 0, 0.1); border-radius: 9999px; overflow: hidden; height: 1.25rem; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, #34D399, #60A5FA); border-radius: 9999px; transition: width 0.5s ease-in-out; text-align: center; color: white; font-weight: bold; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="text-slate-800">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">

        <header class="text-center mb-8 p-6 glass-card rounded-2xl no-hover">
            <div class="flex justify-center items-center gap-4">
                <h1 class="text-4xl md:text-5xl font-bold text-slate-700">Rutina de Estrellas</h1>
                <button id="profile-manager-btn" title="Gestionar Perfiles" class="bg-white/50 hover:bg-white/80 rounded-full p-2 transition-transform transform hover:scale-110">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 A0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                </button>
            </div>
            <p class="text-lg text-slate-500 mt-2">¬°Hola, <span id="child-name" class="font-bold cursor-pointer underline decoration-dotted text-slate-600" title="Haz clic para cambiar el nombre">Peque</span>! ¬°Vamos a por un d√≠a genial!</p>
            <div class="mt-4 flex justify-center items-center gap-4">
                <div id="streak-counter" class="hidden items-center justify-center bg-orange-500 text-white font-bold px-4 py-3 rounded-full text-xl shadow-lg" title="Racha de d√≠as completados">
                    <span id="streak-count">0</span><span class="text-2xl ml-1">üî•</span>
                </div>
                <div class="inline-flex items-center justify-center bg-yellow-400 text-white font-bold px-6 py-3 rounded-full text-2xl shadow-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>
                    <span id="points-display">0</span>
                </div>
            </div>
            <div class="mt-6 max-w-md mx-auto">
                <p class="text-slate-500 font-semibold mb-2">Progreso del D√≠a</p>
                <div class="progress-bar-container">
                    <div id="daily-progress-bar" class="progress-bar" style="width: 0%;">0%</div>
                </div>
            </div>
        </header>

        <main id="app-content" class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            <div class="lg:col-span-3 grid grid-cols-1 md:grid-cols-3 gap-6">
                <div id="am-routine" class="glass-card p-4 rounded-2xl"></div>
                <div id="pm-routine" class="glass-card p-4 rounded-2xl"></div>
                <div id="night-routine" class="glass-card p-4 rounded-2xl"></div>
            </div>
            <div class="glass-card p-4 rounded-2xl flex flex-col no-hover">
                <h2 class="text-2xl font-bold text-center mb-4 text-slate-700">Recompensas üéÅ</h2>
                <div id="rewards-list" class="space-y-3 flex-grow"></div>
                <div class="mt-4 space-y-2">
                    <button id="open-rewards-modal-btn" class="w-full bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105">Editar Recompensas</button>
                    <button id="reset-day-btn" class="w-full bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105">‚ú® Nuevo D√≠a</button>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="confirmation-modal" class="modal-backdrop"><div class="modal-content glass-card w-11/12 md:max-w-md mx-auto rounded-2xl shadow-2xl p-6 text-center"><h3 id="confirmation-title" class="text-2xl font-bold mb-2 text-slate-700">¬øEst√°s seguro?</h3><p id="confirmation-message" class="text-slate-500 mb-6"></p><div class="flex justify-center gap-4"><button id="confirm-action-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-8 rounded-lg">Confirmar</button><button id="cancel-action-btn" class="bg-slate-400 hover:bg-slate-500 text-white font-bold py-2 px-8 rounded-lg">Cancelar</button></div></div></div>
    <div id="profile-modal" class="modal-backdrop"><div class="modal-content glass-card w-11/12 md:max-w-lg mx-auto rounded-2xl shadow-2xl p-6"><h3 class="text-2xl font-bold mb-4 text-slate-700">Gestionar Perfiles</h3><div id="profile-list" class="space-y-3 mb-4"></div><div class="flex gap-2"><input id="new-profile-avatar" type="text" class="w-16 border-2 border-slate-300 bg-white/80 text-slate-800 placeholder-slate-400 rounded-lg p-2 text-center text-2xl" placeholder="üòÄ" maxlength="2"><input id="new-profile-name" type="text" class="flex-grow border-2 border-slate-300 bg-white/80 text-slate-800 placeholder-slate-400 rounded-lg p-2" placeholder="Nombre del nuevo perfil..."><button id="add-profile-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold p-3 rounded-lg text-2xl flex items-center justify-center">+</button></div><div class="mt-6 text-right"><button id="close-profile-modal-btn" class="bg-slate-400 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded-lg">Cerrar</button></div></div></div>
    <div id="task-modal" class="modal-backdrop"> <div class="modal-content glass-card w-11/12 md:max-w-lg mx-auto rounded-2xl shadow-2xl p-6"> <h3 id="task-modal-title" class="text-2xl font-bold mb-4 text-slate-700">Editar Tareas</h3> <div id="task-modal-body" class="space-y-3"></div> <div class="mt-4 bg-slate-100/50 p-3 rounded-lg"> <h4 class="font-bold mb-2">A√±adir Nueva Tarea</h4> <input id="new-task-text" type="text" class="w-full border-2 border-slate-300 bg-white/80 text-slate-800 placeholder-slate-400 rounded-lg p-2" placeholder="Texto de la nueva tarea..."> <div class="flex gap-2 mt-2"> <input id="new-task-icon" type="text" class="w-1/3 border-2 border-slate-300 bg-white/80 text-slate-800 placeholder-slate-400 rounded-lg p-2" placeholder="Emoji üëï"> <input id="new-task-points" type="number" class="w-2/3 border-2 border-slate-300 bg-white/80 text-slate-800 placeholder-slate-400 rounded-lg p-2" placeholder="Puntos en estrellas ‚≠ê"> </div> <button id="add-task-btn" class="w-full mt-2 bg-green-500 hover:bg-green-600 text-white font-bold py-2 rounded-lg">A√±adir Tarea</button> </div> <div class="mt-6 text-right"> <button id="close-task-modal-btn" class="bg-slate-400 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded-lg">Cerrar</button> </div> </div> </div>
    <div id="rewards-modal" class="modal-backdrop"> <div class="modal-content glass-card w-11/12 md:max-w-lg mx-auto rounded-2xl shadow-2xl p-6"> <h3 class="text-2xl font-bold mb-4 text-slate-700">Editar Recompensas</h3> <div id="rewards-modal-body" class="space-y-3"></div> <div class="mt-4"> <input id="new-reward-text" type="text" class="w-full border-2 border-slate-300 bg-white/80 text-slate-800 placeholder-slate-400 rounded-lg p-2" placeholder="Descripci√≥n..."> <input id="new-reward-points" type="number" class="w-full mt-2 border-2 border-slate-300 bg-white/80 text-slate-800 placeholder-slate-400 rounded-lg p-2" placeholder="Coste en estrellas..."> <button id="add-reward-btn" class="w-full mt-2 bg-green-500 hover:bg-green-600 text-white font-bold py-2 rounded-lg">A√±adir Recompensa</button> </div> <div class="mt-6 text-right"> <button id="close-rewards-modal-btn" class="bg-slate-400 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded-lg">Cerrar</button> </div> </div> </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {

        const synth = new Tone.Synth().toDestination();
        const synthReward = new Tone.PolySynth(Tone.Synth).toDestination();
        const rewardNotes = ["C4", "E4", "G4", "C5"];

        let appState = { profiles: {}, currentProfileId: null };
        
        function getDefaultProfileState(name, avatar) {
            const now = Date.now();
            return {
                id: `profile_${now}`,
                childName: name,
                avatar: avatar || 'üòÄ',
                points: 0,
                streak: { count: 0, lastCompletionDate: null },
                routines: {
                    am: { title: '‚òÄÔ∏è Ma√±ana', tasks: [ { id: now+1, text: 'Hacer la cama', icon: 'üõèÔ∏è', completed: false, points: 2 }, { id: now+2, text: 'Vestirse', icon: 'üëï', completed: false, points: 1 }, { id: now+3, text: 'Desayunar', icon: 'ü•£', completed: false, points: 1 } ] },
                    pm: { title: 'üå§Ô∏è Tarde', tasks: [ { id: now+4, text: 'Hacer los deberes', icon: 'üìö', completed: false, points: 3 }, { id: now+5, text: 'Ordenar los juguetes', icon: 'üß∏', completed: false, points: 2 } ] },
                    night: { title: 'üåô Noche', tasks: [ { id: now+6, text: 'Ponerse el pijama', icon: 'üò¥', completed: false, points: 1 }, { id: now+7, text: 'Cenar', icon: 'üç≤', completed: false, points: 1 }, { id: now+8, text: 'Leer un cuento', icon: 'üìñ', completed: false, points: 2 } ] }
                },
                rewards: [ { id: now+9, text: '30 min de pantalla', points: 10, redeemed: false }, { id: now+10, text: 'Un postre especial', points: 15, redeemed: false } ],
                lastResetDate: new Date().toISOString().slice(0, 10)
            };
        }
        
        function getCurrentState() { return appState.profiles[appState.currentProfileId]; }
        function saveState() { localStorage.setItem('starRoutineApp', JSON.stringify(appState)); }

        function loadState() {
            const savedState = localStorage.getItem('starRoutineApp');
            if (savedState) {
                appState = JSON.parse(savedState);
                if (!appState.currentProfileId || !appState.profiles[appState.currentProfileId]) {
                    appState.currentProfileId = Object.keys(appState.profiles)[0] || null;
                }
            }
            if (Object.keys(appState.profiles).length === 0) {
                const defaultProfile = getDefaultProfileState('Peque', 'üòÄ');
                appState.profiles[defaultProfile.id] = defaultProfile;
                appState.currentProfileId = defaultProfile.id;
            }
            const state = getCurrentState();
            if(state) {
                const today = new Date().toISOString().slice(0, 10);
                if (state.lastResetDate !== today) {
                    resetDay(false);
                }
            }
        }
        
        function render() {
            const state = getCurrentState();
            if (!state) {
                document.getElementById('app-content').style.display = 'none';
                document.getElementById('child-name').textContent = '...';
                document.getElementById('points-display').textContent = '0';
                openProfileModal();
                return;
            }
            document.getElementById('app-content').style.display = 'grid';
            document.getElementById('child-name').textContent = state.childName;
            document.getElementById('points-display').textContent = state.points;
            renderStreak();
            renderRoutines();
            renderRewards();
            updateProgressBar();
        }
        
        function renderRoutines() {
            const state = getCurrentState();
            const routineContainerMapping = { am: document.getElementById('am-routine'), pm: document.getElementById('pm-routine'), night: document.getElementById('night-routine') };
            for (const key in state.routines) {
                const routine = state.routines[key];
                const container = routineContainerMapping[key];
                container.innerHTML = `<h2 class="text-2xl font-bold text-center mb-4 text-slate-700">${routine.title}</h2><div class="space-y-3">${routine.tasks.map(task => createTaskHTML(task, key)).join('')}</div><button data-routine-key="${key}" class="edit-tasks-btn mt-4 w-full bg-slate-200 hover:bg-slate-300 text-slate-600 font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105">Editar</button>`;
            }
        }

        function createTaskHTML(task, routineKey) {
            return `<div class="task-card flex items-center p-3 cursor-pointer ${task.completed ? 'completed' : ''}" data-task-id="${task.id}" data-routine-key="${routineKey}">
                <div class="flex-shrink-0 w-12 h-12 bg-sky-100 rounded-full flex items-center justify-center text-3xl mr-3">
                    ${task.icon}
                </div>
                <div class="flex-grow task-text font-semibold text-slate-700">
                    ${task.text}
                </div>
                <div class="flex items-center gap-1 font-bold text-lg text-amber-500">
                    <span>${task.points}</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>
                </div>
            </div>`;
        }
        
        function handleToggleTask(taskId, routineKey) {
            const state = getCurrentState(); 
            const task = state.routines[routineKey].tasks.find(t => t.id == taskId);
            if (task) { 
                task.completed = !task.completed; 
                if (task.completed) { 
                    state.points += task.points; 
                    synth.triggerAttackRelease("C5", "8n"); 
                } else { 
                    state.points = Math.max(0, state.points - task.points); 
                } 
                saveState(); 
                render(); 
            }
        }

        function renderRewards() {
            const state = getCurrentState();
            const rewardsContainer = document.getElementById('rewards-list');
            if (state.rewards.length === 0) {
                rewardsContainer.innerHTML = `<p class="text-center text-slate-500">A√±ade recompensas para canjear estrellas.</p>`;
                return;
            }
            rewardsContainer.innerHTML = state.rewards.map(createRewardHTML).join('');
        }

        function createRewardHTML(reward) {
            const state = getCurrentState();
            const canAfford = state.points >= reward.points;
            let buttonHTML = reward.redeemed ? `<button disabled class="w-full bg-slate-300 text-slate-500 font-bold py-2 px-3 rounded-lg text-sm">Canjeado</button>` : `<button data-reward-id="${reward.id}" class="redeem-reward-btn w-full ${canAfford ? 'bg-green-500 hover:bg-green-600' : 'bg-slate-400'} text-white font-bold py-2 px-3 rounded-lg text-sm transition-all" ${!canAfford ? 'disabled' : ''}>Canjear</button>`;
            return `<div class="p-3 rounded-lg border border-white/50 ${reward.redeemed ? 'bg-slate-100' : 'bg-white/50'}"><p class="font-semibold text-slate-700 ${reward.redeemed ? 'line-through opacity-60' : ''}">${reward.text}</p><div class="flex justify-between items-center mt-2"><div class="flex items-center font-bold text-yellow-500"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1 text-yellow-400" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>${reward.points}</div>${buttonHTML}</div></div>`;
        }

        function updateProgressBar() { const state = getCurrentState(); if(!state) return; const allTasks = Object.values(state.routines).flatMap(r => r.tasks); const completedTasks = allTasks.filter(t => t.completed).length; const totalTasks = allTasks.length; const percentage = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0; const progressBar = document.getElementById('daily-progress-bar'); progressBar.style.width = `${percentage}%`; progressBar.textContent = `${percentage}%`; }

        function renderStreak() {
            const state = getCurrentState();
            const streakCounter = document.getElementById('streak-counter');
            if (state.streak && state.streak.count > 0) {
                document.getElementById('streak-count').textContent = state.streak.count;
                streakCounter.classList.remove('hidden');
                streakCounter.classList.add('inline-flex');
            } else {
                streakCounter.classList.add('hidden');
                streakCounter.classList.remove('inline-flex');
            }
        }
        
        function updateStreak() {
            const state = getCurrentState();
            const allTasks = Object.values(state.routines).flatMap(r => r.tasks);
            if (allTasks.length === 0) return;
            const completedTasks = allTasks.filter(t => t.completed).length;
            const percentage = Math.round((completedTasks / allTasks.length) * 100);
            const today = new Date().toISOString().slice(0, 10);
            const yesterday = new Date(Date.now() - 864e5).toISOString().slice(0, 10);
            
            if (percentage >= 80) {
                if (state.streak.lastCompletionDate === yesterday) {
                    state.streak.count = (state.streak.count || 0) + 1;
                } else if (state.streak.lastCompletionDate !== today) {
                    state.streak.count = 1;
                }
                state.streak.lastCompletionDate = today;
            } else {
                 if (state.streak.lastCompletionDate && state.streak.lastCompletionDate < yesterday) {
                    state.streak.count = 0;
                }
            }
        }

        function executeReset() {
            updateStreak();
            const state = getCurrentState();
            Object.values(state.routines).forEach(r => r.tasks.forEach(t => t.completed = false));
            state.rewards.forEach(r => r.redeemed = false);
            state.lastResetDate = new Date().toISOString().slice(0, 10);
            saveState(); render();
        }
        function resetDay(confirm = true) { if (confirm) { showConfirmation("¬øReiniciar el d√≠a?", "Esto marcar√° todas las tareas como no completadas y reiniciar√° las recompensas.", executeReset); } else { executeReset(); } }

        const profileModal = document.getElementById('profile-modal');
        document.getElementById('profile-manager-btn').addEventListener('click', openProfileModal);
        document.getElementById('close-profile-modal-btn').addEventListener('click', () => profileModal.style.display = 'none');
        function openProfileModal() { renderProfileList(); profileModal.style.display = 'flex'; }
        
        document.getElementById('add-profile-btn').addEventListener('click', () => {
            const nameInput = document.getElementById('new-profile-name');
            const avatarInput = document.getElementById('new-profile-avatar');
            const name = nameInput.value.trim();
            const avatar = avatarInput.value.trim() || 'üòÄ';
            if (name) {
                const newProfile = getDefaultProfileState(name, avatar);
                appState.profiles[newProfile.id] = newProfile;
                appState.currentProfileId = newProfile.id;
                nameInput.value = ''; avatarInput.value = '';
                saveState(); render(); renderProfileList();
            }
        });
        
        function renderProfileList() {
            const listEl = document.getElementById('profile-list');
            listEl.innerHTML = Object.values(appState.profiles).map(p => `
                <div class="flex items-center gap-3 bg-white/50 p-2 rounded-lg">
                    <span class="text-3xl">${p.avatar}</span>
                    <span class="flex-grow text-slate-700 font-semibold">${p.childName}</span>
                    ${p.id === appState.currentProfileId 
                        ? '<span class="text-xs font-bold text-green-800 bg-green-200 px-2 py-1 rounded-full">ACTIVO</span>' 
                        : `<button data-profile-id="${p.id}" class="switch-profile-btn bg-sky-500 hover:bg-sky-600 text-white text-xs font-bold py-1 px-2 rounded-md">Elegir</button>`}
                    <button data-profile-id="${p.id}" class="delete-profile-btn text-red-400 hover:text-red-600 font-bold p-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                </div>
            `).join('');
        }
        
        profileModal.addEventListener('click', (e) => {
            const switchBtn = e.target.closest('.switch-profile-btn');
            const deleteBtn = e.target.closest('.delete-profile-btn');
            if (switchBtn) { appState.currentProfileId = switchBtn.dataset.profileId; saveState(); render(); renderProfileList(); }
            if (deleteBtn) {
                if (Object.keys(appState.profiles).length <= 1) { alert("No puedes eliminar el √∫nico perfil existente."); return; }
                showConfirmation('¬øEliminar perfil?', `Se borrar√°n todos los datos de "${appState.profiles[deleteBtn.dataset.profileId].childName}". Esta acci√≥n no se puede deshacer.`, () => {
                    const idToDelete = deleteBtn.dataset.profileId; delete appState.profiles[idToDelete];
                    if (appState.currentProfileId === idToDelete) { appState.currentProfileId = Object.keys(appState.profiles)[0]; }
                    saveState(); render(); renderProfileList();
                });
            }
        });

        const confirmationModal = document.getElementById('confirmation-modal');
        let onConfirmCallback = null;
        function showConfirmation(title, message, callback) {
            document.getElementById('confirmation-title').textContent = title;
            document.getElementById('confirmation-message').textContent = message;
            onConfirmCallback = callback;
            confirmationModal.style.display = 'flex';
        }
        document.getElementById('confirm-action-btn').addEventListener('click', () => { if (typeof onConfirmCallback === 'function') { onConfirmCallback(); } confirmationModal.style.display = 'none'; });
        document.getElementById('cancel-action-btn').addEventListener('click', () => confirmationModal.style.display = 'none');
        
        document.querySelector('body').addEventListener('click', (e) => {
            const taskCard = e.target.closest('.task-card');
            const redeemBtn = e.target.closest('.redeem-reward-btn');
            const editTasksBtn = e.target.closest('.edit-tasks-btn');
            if (taskCard) {
                const { taskId, routineKey } = taskCard.dataset; 
                handleToggleTask(taskId, routineKey);
            }
            if (redeemBtn) handleRedeemReward(redeemBtn.dataset.rewardId);
            if (editTasksBtn) openTaskModal(editTasksBtn.dataset.routineKey);
        });
        document.getElementById('child-name').addEventListener('click', handleChangeChildName);
        document.getElementById('reset-day-btn').addEventListener('click', () => resetDay(true));
        
        function handleRedeemReward(rewardId) {
            const state = getCurrentState(); const reward = state.rewards.find(r => r.id == rewardId);
            if(reward && !reward.redeemed && state.points >= reward.points) { state.points -= reward.points; reward.redeemed = true; synthReward.triggerAttackRelease(rewardNotes, "8n"); confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } }); saveState(); render(); }
        }
        function handleChangeChildName() {
            const state = getCurrentState(); const newName = prompt("Puedes cambiar el nombre:", state.childName);
            if (newName && newName.trim() !== '') { state.childName = newName.trim(); saveState(); render(); }
        }
        
        const taskModal = document.getElementById('task-modal');
        let currentEditingRoutine = null;
        function openTaskModal(routineKey) {
            currentEditingRoutine = routineKey; const state = getCurrentState(); const routine = state.routines[routineKey];
            document.getElementById('task-modal-title').textContent = `Editar ${routine.title}`;
            const modalBody = document.getElementById('task-modal-body');
            modalBody.innerHTML = routine.tasks.map(task => `<div class="flex items-center gap-2 bg-white/80 p-2 rounded-lg"><input type="text" value="${task.icon}" data-task-id="${task.id}" data-field="icon" class="task-edit-input w-12 border-2 border-slate-300 rounded p-1 text-center"><input type="text" value="${task.text}" data-task-id="${task.id}" data-field="text" class="task-edit-input flex-grow border-2 border-slate-300 rounded p-1"><input type="number" value="${task.points}" data-task-id="${task.id}" data-field="points" class="task-edit-input w-20 border-2 border-slate-300 rounded p-1" placeholder="Pts."><button data-task-id="${task.id}" class="delete-task-btn text-red-400 hover:text-red-600 font-bold p-1">üóëÔ∏è</button></div>`).join('');
            taskModal.style.display = 'flex';
        }
        document.getElementById('close-task-modal-btn').addEventListener('click', () => taskModal.style.display = 'none');
        document.getElementById('add-task-btn').addEventListener('click', () => {
            const state = getCurrentState(); 
            const text = document.getElementById('new-task-text').value; 
            const icon = document.getElementById('new-task-icon').value;
            const points = parseInt(document.getElementById('new-task-points').value, 10) || 1;
            if (text.trim() && icon.trim() && currentEditingRoutine) { 
                state.routines[currentEditingRoutine].tasks.push({ id: Date.now(), text, icon, completed: false, points }); 
                saveState(); render(); openTaskModal(currentEditingRoutine); 
                document.getElementById('new-task-text').value = ''; 
                document.getElementById('new-task-icon').value = ''; 
                document.getElementById('new-task-points').value = ''; 
            }
        });
        taskModal.addEventListener('click', (e) => {
            const deleteBtn = e.target.closest('.delete-task-btn'); if (deleteBtn) { const state = getCurrentState(); const taskId = deleteBtn.dataset.taskId; state.routines[currentEditingRoutine].tasks = state.routines[currentEditingRoutine].tasks.filter(t => t.id != taskId); saveState(); render(); openTaskModal(currentEditingRoutine); }
        });
        taskModal.addEventListener('change', (e) => { 
            if (e.target.classList.contains('task-edit-input')) { 
                const state = getCurrentState(); const { taskId, field } = e.target.dataset; 
                const task = state.routines[currentEditingRoutine].tasks.find(t => t.id == taskId); 
                if (task) { 
                    task[field] = field === 'points' ? (parseInt(e.target.value, 10) || 1) : e.target.value;
                    saveState(); 
                    render(); 
                } 
            } 
        });

        const rewardsModal = document.getElementById('rewards-modal');
        document.getElementById('open-rewards-modal-btn').addEventListener('click', openRewardsModal);
        document.getElementById('close-rewards-modal-btn').addEventListener('click', () => rewardsModal.style.display = 'none');
        function openRewardsModal() {
            const state = getCurrentState(); const modalBody = document.getElementById('rewards-modal-body');
            modalBody.innerHTML = state.rewards.map(reward => `<div class="flex items-center gap-2"><input type="text" value="${reward.text}" data-reward-id="${reward.id}" data-field="text" class="reward-edit-input flex-grow border-2 border-slate-300 bg-white/80 rounded p-1"><input type="number" value="${reward.points}" data-reward-id="${reward.id}" data-field="points" class="reward-edit-input w-20 border-2 border-slate-300 bg-white/80 rounded p-1"><button data-reward-id="${reward.id}" class="delete-reward-btn text-red-400 hover:text-red-600 font-bold p-1">üóëÔ∏è</button></div>`).join('');
            rewardsModal.style.display = 'flex';
        }
        document.getElementById('add-reward-btn').addEventListener('click', () => {
            const state = getCurrentState(); const text = document.getElementById('new-reward-text').value; const points = parseInt(document.getElementById('new-reward-points').value, 10);
            if (text.trim() && points > 0) { state.rewards.push({ id: Date.now(), text, points, redeemed: false }); saveState(); render(); openRewardsModal(); document.getElementById('new-reward-text').value = ''; document.getElementById('new-reward-points').value = ''; }
        });
        rewardsModal.addEventListener('click', (e) => { const deleteBtn = e.target.closest('.delete-reward-btn'); if (deleteBtn) { const state = getCurrentState(); state.rewards = state.rewards.filter(r => r.id != deleteBtn.dataset.rewardId); saveState(); render(); openRewardsModal(); } });
        rewardsModal.addEventListener('change', (e) => { if (e.target.classList.contains('reward-edit-input')) { const state = getCurrentState(); const { rewardId, field } = e.target.dataset; const reward = state.rewards.find(r => r.id == rewardId); if (reward) { reward[field] = field === 'points' ? parseInt(e.target.value, 10) : e.target.value; saveState(); render(); } } });

        loadState();
        render();
    });
    </script>
</body>
</html>

